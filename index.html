<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Days in Maghribal - Polish Ver</title>
    <link rel="icon" href="data:,">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <script src="js/game_data.js"></script>
</head>
<body>
    <svg style="position:fixed; top:-100%; left:-100%; width:0; height:0;">
        <filter id="water-filter">
            <feTurbulence type="fractalNoise" baseFrequency="0.015 0.015" numOctaves="3" seed="1" result="noise">
                <animate attributeName="baseFrequency" dur="15s" values="0.015 0.015;0.02 0.03;0.015 0.015" repeatCount="indefinite" />
            </feTurbulence>
            <feDisplacementMap in="SourceGraphic" in2="noise" scale="20" />
        </filter>
    </svg>

    <div id="fade-overlay"></div>

    <div id="loading-screen">
        <div style="font-size: 24px; letter-spacing: 5px;">LOADING ASSETS</div>
        <div id="load-bar-container"><div id="load-bar-fill"></div></div>
        <div id="load-status">Initializing...</div>
    </div>

    <div id="debug-toggle-btn" onclick="toggleDebugPanel()"><i class="fa-solid fa-gear"></i></div>
    <div id="debug-panel">
        <div style="font-size: 10px; color: #ffcc00; margin-bottom: 5px; border-bottom: 1px solid #444;">DATA CONTROL</div>
        <button class="debug-btn" onclick="debugResetAllData()" style="color: #ff4d4d;">‚Ü∫ Reset All Data</button>
        <button class="debug-btn" onclick="debugToggleBoosts()" id="debug-boost-btn">üîì Unlock Boosts</button>
        <div style="font-size: 10px; color: #ffcc00; margin: 10px 0 5px; border-bottom: 1px solid #444;">TURN CONTROL</div>
        <div class="debug-row">
            <button class="debug-btn" onclick="debugModTurn(-5)">-5</button>
            <button class="debug-btn" onclick="debugModTurn(-1)">-1</button>
            <button class="debug-btn" onclick="debugModTurn(1)">+1</button>
            <button class="debug-btn" onclick="debugModTurn(5)">+5</button>
        </div>
        <div style="font-size: 10px; color: #ffcc00; margin: 10px 0 5px; border-bottom: 1px solid #444;">EVENT TESTER</div>
        <div style="display: flex; flex-direction: column; gap: 3px; margin-bottom: 5px;">
            <select id="debug-map-select" onchange="updateDebugEventList()" style="background: #222; color: #fff; font-size: 10px; border: 1px solid #b08d55;"></select>
            <select id="debug-event-select" style="background: #222; color: #fff; font-size: 10px; border: 1px solid #b08d55;"></select>
        </div>
        <button class="debug-btn" onclick="launchDebugTestEvent()" style="width: 100%; background: #b08d55; color: #000;">‚ö° Launch Test</button>
        <div style="font-size: 10px; color: #ffcc00; margin: 10px 0 5px; border-bottom: 1px solid #444;">HEROINE PROGRESS</div>
        <div id="debug-heroine-sliders" style="background: rgba(0,0,0,0.3); padding: 5px; border-radius: 4px;"></div>
        <div style="font-size: 10px; color: #ffcc00; margin: 10px 0 5px; border-bottom: 1px solid #444;">GAMEPLAY</div>
        <button class="debug-btn" onclick="debugMaxStats()">‚òÖ Max</button>
        <button class="debug-btn" onclick="debugFinishGame()">üèÅ Finish</button>
        <button id="force-heroine-btn" class="debug-btn" onclick="toggleForceHeroine()">‚ô• Force: OFF</button>
    </div>

    <div id="game-container">
        <div id="background-layer"></div>
        
        <div id="monologue-container"><div class="monologue-text"></div></div>

        <div id="map-spots-container"></div>
        
        
        <div id="top-ui-container">
            <div id="turn-display"><span style="margin-right:15px; font-weight:bold;"><i class="fa-solid fa-hourglass-start"></i> TURN</span><span id="turn-count">1</span>/20</div>
            <button id="status-toggle-btn" class="ui-btn" onclick="toggleStats()">STATUS</button>
            <button id="log-btn" class="ui-btn" onclick="toggleLog()">LOG</button>
            <button id="fullscreen-btn" class="fullscreen-btn" onclick="toggleFullScreen()"><i class="fa-solid fa-expand"></i></button>
        </div>

        <div id="stats-panel"><div id="stat-list"></div></div>
        <div id="log-overlay"><div id="log-window"><div id="log-content"></div></div><button class="ui-btn" onclick="toggleLog()">CLOSE</button></div>
        
        <div id="click-overlay" onclick="advanceMessage()"></div>
        <div id="message-window" onclick="advanceMessage()">
            <div id="location-badge">
                <span id="loc-icon"></span><span id="loc-name"></span>
                <span id="loc-stats"></span>
            </div>
            <div id="char-name-badge"></div>
            <div id="message-text"></div>
            <div id="result-display"></div>
            <div id="page-cursor"><i class="fa-solid fa-caret-down"></i></div>
        </div>
        
        <div id="title-screen" class="overlay-screen">
            <div id="title-img-bg" style="background-image: url('images/title.png');"></div>
            <button id="title-fullscreen-btn" class="fullscreen-btn" onclick="toggleFullScreen()"><i class="fa-solid fa-expand"></i></button>
            
            <div class="title-logo-wrapper">
                <div class="title-logo-container">
                    <h1 class="size-days">DAYS</h1><h1 class="size-in">IN</h1><h1 class="size-magh">MAGHRIBAL</h1>
                </div>
                <div class="title-underline"></div>
                <h2 class="jp-title">- „Éû„Ç∞„É™„Éê„É´„Å´„Å¶ -</h2>
            </div>

            <div class="title-btn-container">
                <button id="start-btn" onclick="startOP()">GAME START</button>
                <button id="continue-btn" onclick="continueGame()">CONTINUE</button>
            </div>

            <div id="boost-container"></div>
            <div id="past-records-container">
                <div class="record-title"><i class="fa-solid fa-clock-rotate-left"></i> PAST RECORDS</div>
                <div id="past-records-list"></div>
            </div>
        </div>

        <div id="op-screen" class="overlay-screen hidden-screen" onclick="nextOP()">
            <div id="op-text"></div><div style="position:absolute; bottom:30px;"><i class="fa-solid fa-caret-down" style="font-size:24px; color:#b08d55; animation:cursorBlink 1s infinite alternate;"></i></div>
        </div>

        <div id="ed-screen" class="overlay-screen hidden-screen">
            <div id="ed-rank"></div>
            <div id="ed-heroine" style="color:#ffcc00; font-weight:bold; margin-bottom:20px; display: flex; justify-content: center; align-items: center; gap: 4px;"></div>
            <div id="ed-msg"></div>
            <div id="ed-stats"></div>
            <div style="display:flex; gap:20px; align-items:center;">
                <button id="ed-log-btn" onclick="toggleLog()">REVIEW LOG</button>
                <button id="retry-btn" onclick="location.reload()">RETRY</button>
            </div>
        </div>
    </div>

    <script>
        const sePi = new Audio('se/pi.mp3'); const seOp = new Audio('se/op.mp3'); const seFootstep = new Audio('se/za.mp3'); const sePage = new Audio('se/pera.mp3');
        const bgmOp = new Audio('bgm/op.mp3'); bgmOp.loop = true; bgmOp.volume = 0.3;
        const bgmMap = new Audio('bgm/map.mp3'); bgmMap.loop = true; bgmMap.volume = 0.3;
        const bgmEd = new Audio('bgm/ed.mp3'); bgmEd.loop = true; bgmEd.volume = 0.3;
        
        function playSE(audio) {
            const clone = audio.cloneNode();
            clone.volume = audio.volume;
            clone.play();
        }

        const statColors = { health: '#ff4d4d', body: '#ffa500', mind: '#4da6ff', magic: '#b366ff', fame: '#ffff4d', money: '#33cc33' };
        const rankColors = { LEGEND: '#ffcc00', GOLD: '#e6b422', SILVER: '#c0c0c0', BRONZE: '#cd7f32' };
        const soloTitles = { health: "‰∏çÊªÖ„ÅÆÂÜíÈô∫ËÄÖ", body: "Â≠§È´ò„ÅÆÊã≥Áéã", mind: "Ê∑±Ê∑µ„ÅÆÊ±ÇÈÅìËÄÖ", magic: "ÁÑ°Á™Æ„ÅÆÈ≠îË°ìÂ∏´", fame: "Âêç„ÇÇ„Å™„Åç‰ºùË™¨", money: "Ë±™ËÖï„ÅÆÂ§ßÂØåË±™" };
        
        const impactConfig = {
            "„Ç™„É´„ÉÜ„É≥„Ç∑„Ç¢": { targetName: "Ëæ∫Â¢É„ÅÆÊùë", sec: 1, eco: 1, name: "ÁéãÂÆ∂„ÅÆÈÖçÁµ¶" },
            "„Ç®„É´„Éä": { targetName: "ÈùôË¨ê„Å™‰øÆÈÅìÈô¢", sec: 1, eco: 0, name: "ÂèéÁ©´„ÅÆÁ•à„Çä" },
            "„Ç∑„É´„Éï„Ç£„Ç®„ÉÉ„Éà": { targetName: "Ë≥¢ËÄÖ„ÅÆÂ°î", sec: 0, eco: 0, name: "Âè§Êõ∏„ÅÆÂØÑË¥à" },
            "„É´„Éä„É™„Çπ": { targetName: "Ëø∑ÂÆÆ„ÅÆÂÖ•„ÇäÂè£", sec: -1, eco: 1, name: "Ê∑±Ê∑µ„ÅÆËß£Êòé" },
            "„Éû„É™„Éº„Éä": { targetName: "ÂÖ≠Ëßí„ÅÆÁéãÈÉΩ", sec: -1, eco: 1, name: "ÈóáÂ∏ÇÂ†¥" },
            "„Ç´„Çø„É™„Éä": { targetName: "Ë≥ë„Çè„ÅÑ„ÅÆÊ∏ØÁî∫", sec: 1, eco: -1, name: "Êµ∑Ë≥äÁã©„Çä" },
            "„Ç®„É™„Çπ„Éï„Çß„É™„Ç¢": { targetName: "Â§™Âè§„ÅÆÂ¢ìÂú∞", sec: 1, eco: 1, name: "Á≤æÈúäÁ•≠" },
            "„É¨„Ç∞„É™„Éä": { targetName: "ÂñßÈ®í„ÅÆÈóòÊäÄÂ†¥", sec: -1, eco: 1, name: "ÁúüÂ§ú‰∏≠" },
            "„Çº„Éï„Ç°„Éº": { targetName: "Á∑ë„ÅÆÈö†„ÇåÈáå", sec: 1, eco: 1, name: "Áï∞ÊñáÂåñ" },
            "„É°„É´„É´": { targetName: "Â∑®Â≤©„ÅÆË¶ÅÂ°û", sec: 0, eco: 0, name: "ÂÇ≠ÂÖµÂõ£" },
            "„Éç„ÇØ„É≠„Ç¢": { targetName: "Âøò„Çå„Çâ„Çå„ÅüÂè§Âüé", sec: -1, eco: 1, name: "ÂπªÂΩ±„ÅÆÁ•ùÂÆ¥" },
            "„Ç®„É´„É¥„Ç£„Éº„É©": { targetName: "ÁúüÈçÆ„ÅÆËçíÈáé", sec: 1, eco: 0, name: "Á†ÇÊº†„ÅÆËä±" }
        };
        
        let heroineImpacts = []; 
        let isResultHidden = false;
        let lastEventContext = null; 
        let lastEventResult = null;
        let monologueInterval;
        let specialData = []; 
        let monologueData = {}; 
        let heroineReactions = {}; 
        let clearedHeroines = [];

        const heroineOPLines = [
            ["ÁéãÈÉΩ„ÅÆÂ®ÅÂÖâ„ÅåËæ∫Â¢É„ÇíÁÖß„Çâ„Åô„ÄÇ", "ÁéãÂ•≥„ÅÆÂëΩ„Å´„Çà„Çä„ÄÅË≤ß„Åó„ÅçÊùë„Å´Áâ©Ë≥á„ÅåÂ±ä„Åë„Çâ„Çå„Åü„ÄÇ", "Â∏åÊúõ„ÅÆÂÖâ„Åå„ÄÅ‰∫∫„ÄÖ„ÅÆÁû≥„Å´ÂÆø„ÇäÂßã„ÇÅ„Çã„ÄÇ"], 
            ["Ë≥¢ËÄÖ„ÅÆÂè°Êô∫„Åå„ÄÅËø∑ÂÆÆ„ÅÆÊ∑±Ê∑µ„ÇíÁÖß„Çâ„Åô„ÄÇ", "Â∞ÅÂç∞„ÅåËß£„Åã„Çå„ÄÅÂÜíÈô∫ËÄÖ„Åü„Å°„ÅåÊ∑±Â±§„Å∏„Å®Êåë„ÇÄ„ÄÇ", "Âç±Èô∫„Å®Èö£„ÇäÂêà„Çè„Åõ„ÅÆ„ÄÅÂØå„Å∏„ÅÆÊââ„ÅåÈñã„Åã„Çå„Åü„ÄÇ"],
            ["Ëæ∫Â¢É„ÅÆÂÆü„Çä„Åå„ÄÅ‰øÆÈÅìÈô¢„ÅÆÈ£üÂçì„ÇíÊ∫Ä„Åü„Åô„ÄÇ", "Êùë‰∫∫„Åü„Å°„ÅåÂ±ä„Åë„ÅüÊñ∞ÈÆÆ„Å™Á≥ß„Åå„ÄÅÁ•à„Çä„ÅÆÂ†¥„ÇíÊîØ„Åà„Çã„ÄÇ", "„Åï„Åï„ÇÑ„Åã„Å™Âπ∏Á¶è„Åå„ÄÅÈùô„Åã„Å´Ê∫Ä„Å°„Å¶„ÅÑ„Åè„ÄÇ"],
            ["Á¶ÅÂøå„ÅÆÁü•Ë≠ò„Åå„ÄÅÂ°î„ÅÆÂ§ú„ÇíÊÄ™„Åó„ÅèÁÖß„Çâ„Åô„ÄÇ", "Âè§Âüé„Åã„ÇâÊåÅ„Å°Ëæº„Åæ„Çå„ÅüÂè§ÊñáÊõ∏„Åå„ÄÅË≥¢ËÄÖ„Åü„Å°„ÇíÁÜ±ÁãÇ„Åï„Åõ„Çã„ÄÇ", "Áü•„ÅÆ‰∫§ÊµÅ„Åå„ÄÅÊñ∞„Åü„Å™Áô∫Ë¶ã„ÇíÁîü„ÇÄ„ÄÇ"],
            ["Ê∏Ø„ÅÆÁÜ±Ê∞ó„Åå„ÄÅÁéãÈÉΩ„ÅÆÂ§ú„ÇíÂΩ©„Çã„ÄÇ", "Êµ∑„Åã„Çâ„ÅÆÁèçÂìÅ„ÅåÈóáÂ∏ÇÂ†¥„Å´Ê∫¢„Çå„ÄÅË≤¥Êóè„Åü„Å°„ÇíÈ≠Ö‰∫Ü„Åô„Çã„ÄÇ", "Ê¨≤Êúõ„Å®ÈáëË≤®„Åå„ÄÅË°ó„ÅÆÂΩ±„ÅßÊ∏¶Â∑ª„ÅÑ„Å¶„ÅÑ„Çã„ÄÇ"],
            ["Â∑®Â≤©„ÅÆÁõæ„Åå„ÄÅÊ∏Ø„ÅÆÊ≥¢Êø§„ÇíÈéÆ„ÇÅ„Çã„ÄÇ", "Ë¶ÅÂ°û„ÅÆÈ®éÂ£´„Åü„Å°„ÅåÊµ∑Ë≥ä„ÇíËøΩ„ÅÑÊâï„ÅÑ„ÄÅ‰∫§ÊòìË∑Ø„ÅåÈñã„Åã„Çå„Åü„ÄÇ", "Ê∏ØÁî∫„ÅØ„Åã„Å§„Å¶„Å™„ÅÑË≥ë„Çè„ÅÑ„ÇíË¶ã„Åõ„Å¶„ÅÑ„Çã„ÄÇ"],
            ["‰øÆÈÅìÈô¢„ÅÆÁ•à„Çä„Åå„ÄÅÂ§™Âè§„ÅÆÈ≠Ç„ÇíÊÖ∞„ÇÅ„Çã„ÄÇ", "ËÅñÂ•≥„ÅÆÊµÑÂåñ„Å´„Çà„Çä„ÄÅÂ¢ìÂú∞„ÅØÂÆâ„Çâ„Åé„ÅÆÂú∞„Å∏„Å®Â§â„Çè„Å£„Åü„ÄÇ", "‰ªäÂÆµ„ÄÅÊ≠ªËÄÖ„ÇíÂÅ≤„Å∂Èùô„Åã„Å™Á•≠„Çä„ÅåÂßã„Åæ„Çã„ÄÇ"],
            ["Âè§Âüé„ÅÆÈóá„Åå„ÄÅÈóòÊäÄÂ†¥„ÅÆÈÆÆË°Ä„ÇíÊ±Ç„ÇÅ„Çã„ÄÇ", "Âê∏Ë°ÄÈ¨º„ÅÆÊàØ„Çå„Åß„ÄÅÂ§ú„Å™Â§ú„Å™ÈÅéÊøÄ„Å™ÊÆ∫„ÅóÂêà„ÅÑ„ÅåË°å„Çè„Çå„Çã„ÄÇ", "Ë¶≥ÂÆ¢„ÅÆÁÜ±ÁãÇ„ÅØ„ÄÅÊÅêÊÄñ„Å®ÂÖ±„Å´ÊúÄÈ´òÊΩÆ„Å∏ÈÅî„Åô„Çã„ÄÇ"],
            ["ËçíÈáé„ÅÆÊÉÖÁÜ±„Åå„ÄÅÈö†„ÇåÈáå„ÅÆÊââ„ÇíÈñã„Åè„ÄÇ", "Ë∏ä„ÇäÂ≠ê„Åü„Å°„ÅÆÊÉÖÁÜ±„Åå„ÄÅÈñâ„Åñ„Åï„Çå„Åü„Ç®„É´„Éï„ÅÆÂøÉ„ÇíÊ∫∂„Åã„Åô„ÄÇ", "Ê£Æ„ÅÆÂ••Ê∑±„Åè„Åß„ÄÅÁ®ÆÊóè„ÇíË∂Ö„Åà„ÅüÂÆ¥„ÅåÂßã„Åæ„Çã„ÄÇ"],
            ["Ëø∑ÂÆÆ„ÅÆÊé¢Ê±ÇËÄÖ„Åå„ÄÅÂøò„Çå„Çâ„Çå„ÅüÂüé„Å´Êåë„ÇÄ„ÄÇ", "‰∫°Èúä„ÅÆÂëº„Å≥Â£∞„Å´Âøú„Åà„ÄÅÂªÉÂ¢ü„Å´Âπª„ÅÆÁÅØ„Çä„Åå„Å®„ÇÇ„Çã„ÄÇ", "„Åã„Å§„Å¶„ÅÆÊ†ÑËèØ„Åå„ÄÅ‰∏ÄÂ§ú„ÅÆÂ§¢„Å®„Åó„Å¶Ëòá„Çã„ÄÇ"],
            ["ÈóòÊäÄÂ†¥„ÅÆÁãÇÈ®í„Åå„ÄÅË¶ÅÂ°û„ÅÆÈùôÂØÇ„ÇíÁ†¥„Çã„ÄÇ", "ÁåõËÄÖ„Åü„Å°„ÅåÂÆàÂÇôÈöä„Å´Âä†„Çè„Çä„ÄÅÈâÑÂ£Å„ÅÆÂÆà„Çä„ÅåÁØâ„Åã„Çå„Åü„ÄÇ", "„Åó„Åã„Åó„ÄÅ„Åù„ÅÆËçí„ÄÖ„Åó„Åï„Å´‰ΩèÊ∞ë„ÅØÊÄØ„Åà„Å¶„ÅÑ„Çã„ÄÇ"],
            ["Ê∑±Á∑ë„ÅÆÊÅØÂêπ„Åå„ÄÅËçíÈáé„Å´ÊΩ§„ÅÑ„Çí„ÇÇ„Åü„Çâ„Åô„ÄÇ", "„Ç®„É´„Éï„ÅÆÁßòË°ì„Å´„Çà„Çä„ÄÅÁ†ÇÊº†„ÅÆÂè™‰∏≠„Å´Ê≥â„ÅåÊπß„ÅçÂá∫„Åó„Åü„ÄÇ", "‰∏çÊØõ„ÅÆÂ§ßÂú∞„Å´„ÄÅÂ•áË∑°„ÅÆËä±„ÅåÂí≤„Åç‰π±„Çå„Çã„ÄÇ"]
        ];

        const defaultRegionStats = [ { sec: 4, eco: 4 }, { sec: 5, eco: 2 }, { sec: 3, eco: 2 }, { sec: 1, eco: 1 }, { sec: 2, eco: 5 }, { sec: 2, eco: 4 }, { sec: 4, eco: 2 }, { sec: 1, eco: 2 }, { sec: 1, eco: 1 }, { sec: 3, eco: 1 }, { sec: 3, eco: 3 }, { sec: 1, eco: 3 } ];
        let stats = { health: 0, body: 0, mind: 0, magic: 0, fame: 0, money: 0 };
        let turn = 1, maxTurn = 20, isEventActive = false, isGameStarted = false, isTyping = false, targetText = "";
        let messageQueue = [], currentMsgIndex = 0, pendingResultHtml = "", typeInterval;
        let consecutiveNormalEvents = 0, lastEventWasHeroine = false, isForcedHeroine = false, isResultDisplayed = false;
        let currentGameLog = [];
        let unlockedBoosts = { health: false, body: false, mind: false, magic: false, fame: false, money: false };
        let activeBoosts = { health: false, body: false, mind: false, magic: false, fame: false, money: false };
        let activeImpacts = Array(12).fill(false);
        const gameAssets = { events: {}, heroines: {} };

        window.onload = async () => {
            const statusEl = document.getElementById("load-status"); const barFill = document.getElementById("load-bar-fill");
            const assetsToLoad = []; 
            
            // ‰øÆÊ≠£Ôºö36„Éï„Ç°„Ç§„É´Ôºà12„Ç®„É™„Ç¢√ó3„É©„É≥„ÇØÔºâ„ÅÆ‰∏ÄÊã¨„É≠„Éº„Éâ
            scenarios.forEach(s => {
                for (let i = 1; i <= 3; i++) {
                    assetsToLoad.push({ type: 'event', file: `${s.file}_${i}` });
                }
            });
            heroines.forEach(h => assetsToLoad.push({ type: 'heroine', file: h.file }));
            
            let loadedCount = 0;
            const loadPromises = assetsToLoad.map(async (asset) => {
                try {
                    const res = await fetch(`data/${asset.type === 'event' ? 'events' : 'heroines'}/${asset.file}.json`);
                    const data = await res.json();
                    if (asset.type === 'event') { 
                        gameAssets.events[asset.file] = data; // ‰æã: gameAssets.events["e01_royal_city_1"] „Å´Ê†ºÁ¥ç
                    }
                    else if (asset.type === 'heroine') { gameAssets.heroines[asset.file] = await fetch(`data/heroines/${asset.file}.json`).then(r => r.json()); }
                    loadedCount++; const percent = (loadedCount / assetsToLoad.length) * 100; barFill.style.width = percent + "%"; statusEl.innerText = `Loading: ${asset.file} (${Math.round(percent)}%)`;
                } catch (e) { console.error(e); }
            });
            await Promise.all(loadPromises);
            
            try {
                const monoRes = await fetch('data/events/monologues.json');
                const monoJson = await monoRes.json();
                monologueData = monoJson.common;
                heroineReactions = monoJson.heroines;
                const specRes = await fetch('data/events/special.json');
                specialData = await specRes.json();
            } catch (e) { console.error("Data load failed", e); }

            heroineImpacts = heroines.map(h => {
                const conf = impactConfig[h.name];
                if (!conf) return { target: 0, sec: 0, eco: 0, name: "Unknown", btnLabel: "???" };
                const targetIdx = scenarios.findIndex(s => s.name === conf.targetName);
                return { 
                    target: targetIdx !== -1 ? targetIdx : 0, 
                    sec: conf.sec, eco: conf.eco, name: conf.name,
                    btnLabel: `${conf.targetName} +`
                };
            });

            const savedB = localStorage.getItem('maghribal_boosts'); if(savedB) unlockedBoosts = JSON.parse(savedB);
            const savedA = localStorage.getItem('maghribal_active_boosts'); if(savedA) activeBoosts = JSON.parse(savedA);
            const savedI = localStorage.getItem('maghribal_active_impacts'); if(savedI) activeImpacts = JSON.parse(savedI);
            const savedC = localStorage.getItem('maghribal_cleared_heroines'); if(savedC) clearedHeroines = JSON.parse(savedC);
            
            initUI(); displayPastRecords(); renderBoostButtons();
            resizeGameContainer(); window.addEventListener('resize', resizeGameContainer);
            
            checkResumeData(); 
            
            setTimeout(() => { document.getElementById("loading-screen").style.display = "none"; }, 800);
        };
        
        function checkResumeData() {
            try {
                const savedSession = localStorage.getItem('maghribal_resume_data');
                if(savedSession) {
                    const btn = document.getElementById('continue-btn');
                    if(btn) {
                        btn.style.display = 'block'; 
                    }
                }
            } catch(e) { console.error("Error checking resume data:", e); }
        }

        function saveSessionData() {
            if (turn > maxTurn && activeImpacts.findIndex(Boolean) === -1) return; 
            try {
                const sessionData = {
                    turn: turn,
                    stats: stats,
                    activeImpacts: activeImpacts,
                    consecutiveNormalEvents: consecutiveNormalEvents,
                    lastEventWasHeroine: lastEventWasHeroine,
                    heroineProgress: heroines.map(h => ({p: h.progress || 0, a: h.affection || 0})),
                    gameLog: currentGameLog
                };
                localStorage.setItem('maghribal_resume_data', JSON.stringify(sessionData));
                
                const contBtn = document.getElementById("continue-btn");
                if(contBtn) contBtn.style.display = "block";
            } catch(e) {
                console.error("Save failed:", e);
            }
        }

        function continueGame() {
            const saved = localStorage.getItem('maghribal_resume_data');
            if (!saved) return;
            try {
                const data = JSON.parse(saved);

                turn = data.turn;
                stats = data.stats;
                activeImpacts = data.activeImpacts || Array(12).fill(false);
                consecutiveNormalEvents = data.consecutiveNormalEvents;
                lastEventWasHeroine = data.lastEventWasHeroine;
                currentGameLog = data.gameLog || [];

                if (data.heroineProgress) {
                    heroines.forEach((h, i) => {
                        if (data.heroineProgress[i]) {
                            h.progress = data.heroineProgress[i].p;
                            h.affection = data.heroineProgress[i].a;
                        }
                    });
                }

                document.getElementById("title-screen").classList.add("hidden-screen");
                document.getElementById("top-ui-container").style.display = "flex";
                document.getElementById("background-layer").classList.add("visible");
                document.querySelectorAll('.map-spot').forEach(s => s.classList.add('spot-visible'));

                statKeys.forEach(k => updateUI(k));
                document.getElementById("turn-count").innerText = turn;
                document.getElementById("log-content").innerHTML = currentGameLog.join('');
                updateMapState();

                bgmOp.pause();
                bgmMap.currentTime = 0;
                bgmMap.play();
                isGameStarted = true;
                
                updateMonologue('resume', false); 
            } catch(e) {
                console.error("Load failed:", e);
                alert("„Çª„Éº„Éñ„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ");
            }
        }

        function resizeGameContainer() { const container = document.getElementById('game-container'); const targetW = 1280; const targetH = 720; const windowW = window.innerWidth; const windowH = window.innerHeight; const scaleW = windowW / targetW; const scaleH = windowH / targetH; const scale = Math.min(scaleW, scaleH); container.style.transform = `scale(${scale})`; }
        function toggleFullScreen() { if (!document.fullscreenElement) { document.documentElement.requestFullscreen().catch(err => { console.log(err); }); } else { if (document.exitFullscreen) { document.exitFullscreen(); } } }
        
        function initUI() {
            const list = document.getElementById("stat-list"); list.innerHTML = ""; statKeys.forEach(k => { list.innerHTML += `<div style="margin-bottom:10px;"><div style="display:flex; justify-content:space-between; font-size:14px;"><span class=\"stat-label\" style=\"color:${statColors[k]};\"><i class=\"fa-solid ${statConfig[k].icon}\"></i> ${statConfig[k].name}</span><span id=\"stat-${k}\" style=\"color:${statColors[k]}; font-weight:bold;\">Low</span></div><div class=\"stat-bar-bg\"><div class=\"stat-bar-fill\" id=\"bar-${k}\" style=\"background:${statColors[k]};\"></div></div></div>`; });
            const container = document.getElementById("map-spots-container"); container.innerHTML = ""; 
            spotAssignments.forEach((assign, i) => { 
                const spot = document.createElement("div"); spot.className = "map-spot"; spot.style.left = assign.l + "%"; spot.style.top = assign.t + "%"; spot.onclick = (e) => { e.stopPropagation(); handleSpotClick(spot, i); }; 
                spot.innerHTML = `<div class=\"spot-core\"></div><div class=\"orb orb-main\" style=\"background:${statColors[assign.main]}; color:${statColors[assign.main]};\"></div><div class=\"orb orb-sub\" style=\"background:${statColors[assign.sub]}; color:${statColors[assign.sub]};\"></div><div class=\"hint-container\"><div class=\"hint-text\"><i class=\"fa-solid ${scenarios[i].icon}\" style=\"margin-right:5px; font-size:0.9em;\"></i>${scenarios[i].name}<div class=\"recommend-icon\"><i class=\"fa-solid fa-angles-up\"></i></div></div></div>`; 
                container.appendChild(spot); 
            }); 
            updateRecommend();
        }

        const updateMonologue = (type = 'random', saveToLog = true) => { 
            const container = document.getElementById('monologue-container');
            const textEl = container.querySelector('.monologue-text');
            
            if (activeImpacts.findIndex(Boolean) !== -1) { container.style.display = 'none'; return; }

            let text = "";
            let pool = [];

            if (type === 'resume') { 
                text = "‚Ä¶‚Ä¶„Åï„Å¶„ÄÅÊóÖ„ÅÆÁ∂ö„Åç„ÇíÂßã„ÇÅ„Çà„ÅÜ„ÄÇ"; 
            } else if (type === 'start') {
                pool = monologueData.start;
            } else if (lastEventContext) { 
                const { name, progress } = lastEventContext;
                const stage = Math.min(progress - 1, 5); 
                if (heroineReactions[name] && heroineReactions[name][stage]) {
                    text = heroineReactions[name][stage];
                } else {
                    pool = monologueData.success; 
                }
                lastEventContext = null;
            } else {
                const maxStats = statKeys.filter(k => stats[k] >= 50);
                if (maxStats.length > 0 && Math.random() < 0.3) { 
                    pool = monologueData.stat_max; 
                } 
                else if (lastEventResult && Math.random() < 0.7) {
                    const resKey = (lastEventResult === 'great_success' || lastEventResult === 'great') ? 'great' : lastEventResult;
                    pool = monologueData[resKey] || monologueData.failure;
                    lastEventResult = null;
                }
                else if (Math.random() < 0.4) { 
                    const unmetHeroines = heroines.filter(h => h.progress === 0);
                    if (unmetHeroines.length > 0 && Math.random() < 0.5) {
                        const target = unmetHeroines[Math.floor(Math.random() * unmetHeroines.length)];
                        const originalIdx = heroines.indexOf(target);
                        if (originalIdx !== -1) {
                            text = `ÂôÇ„Å´„Çà„Çã„Å®„ÄÅ${scenarios[originalIdx].name}„ÅÆÊñπ„Å´${target.title}„Åå„ÅÑ„Çã„Çâ„Åó„ÅÑ„ÄÇ`;
                        }
                    } else {
                        pool = monologueData.hint_weak;
                    }
                }
                else {
                    if (turn < 5) pool = monologueData.progress_low;
                    else if (turn < 15) pool = monologueData.progress_mid;
                    else pool = monologueData.progress_high;
                }
            }

            if (!text) {
                if (!pool || pool.length === 0) pool = monologueData.progress_mid;
                text = pool[Math.floor(Math.random() * pool.length)];
            }

            if (saveToLog) {
                currentGameLog.push(`<div class=\"log-entry monologue-log\">ÔºàÁã¨„ÇäË®ÄÔºâ${text}</div>`);
                const logContent = document.getElementById("log-content");
                if (logContent) {
                    logContent.innerHTML = currentGameLog.join('');
                }
            }

            textEl.innerHTML = "";
            container.style.display = 'flex';
            container.classList.remove('visible');
            void container.offsetWidth; 
            container.classList.add('visible');
            
            clearInterval(monologueInterval);
            let i = 0;
            monologueInterval = setInterval(() => {
                textEl.textContent += text.charAt(i);
                i++;
                if (i >= text.length) clearInterval(monologueInterval);
            }, 50);
        };

        function updateMapState() {
            const activeIdx = activeImpacts.findIndex(Boolean);
            const spots = document.querySelectorAll('.map-spot');
            
            spots.forEach((spot, i) => {
                spot.classList.remove('spot-disabled');
                if (activeIdx !== -1) {
                    const target = heroineImpacts[activeIdx].target;
                    if (i !== target) spot.classList.add('spot-disabled');
                }
            });
            
            const displayEl = document.getElementById("turn-display");
            if (!displayEl) return;

            if (activeIdx !== -1) {
                displayEl.innerHTML = `<span style=\"margin-right:15px; font-weight:bold;\"><i class=\"fa-solid fa-hourglass-start\"></i> TURN</span><span id=\"turn-count\">1</span>/1`;
            } else {
                displayEl.innerHTML = `<span style=\"margin-right:15px; font-weight:bold;\"><i class=\"fa-solid fa-hourglass-start\"></i> TURN</span><span id=\"turn-count\">${turn}</span>/20`;
            }
        }

        function updateRecommend() {
            const vals = Object.values(stats); const minVal = Math.min(...vals); const weakStats = statKeys.filter(k => stats[k] === minVal);
            spotAssignments.forEach((assign, i) => { const isRec = weakStats.includes(assign.main) || weakStats.includes(assign.sub); const spot = document.querySelectorAll('.map-spot')[i]; if(spot) { const icon = spot.querySelector('.recommend-icon'); if(icon) { if (isRec) icon.classList.add('visible'); else icon.classList.remove('visible'); } } });
        }
        function updateUI(k) { const v = stats[k]; const bar = document.getElementById(`bar-${k}`); if(bar) bar.style.width = (v * 2) + "%"; const label = document.getElementById(`stat-${k}`); if(label) { const labs = ["Low", "Normal", "High", "Expert", "Master", "Legend"]; label.innerText = labs[Math.min(Math.floor(v/10),5)]; } updateRecommend(); }
        
function handleSpotClick(el, idx) {
            document.getElementById('monologue-container').classList.remove('visible');

            const activeIdx = activeImpacts.findIndex(Boolean);
            if (activeIdx !== -1 && idx !== heroineImpacts[activeIdx].target) return;

            if (!isGameStarted || isEventActive || (activeIdx === -1 && turn > maxTurn)) return; 
            isEventActive = true; isResultDisplayed = false; isResultHidden = false;
            playSE(seFootstep); 
            
            let stopBgm = false;

            el.querySelector('.hint-text').classList.add('selected-yellow'); 
            document.querySelectorAll('.map-spot').forEach(s => s.classList.remove('spot-visible'));
            
            const s = scenarios[idx];
            const h = heroines[idx]; 
            h.events = gameAssets.heroines[h.file].events; 
            
            const avgStat = Object.values(stats).reduce((a, b) => a + b, 0) / 6;
            const assign = spotAssignments[idx];
            const anyM = heroines.some(hero => hero.progress >= 5);
            
            const minVal = Math.min(...Object.values(stats)); 
            const weakStats = statKeys.filter(k => stats[k] === minVal); 
            const isRecommended = weakStats.includes(assign.main) || weakStats.includes(assign.sub);
            
            let tierNum, tierKey; 
            const progressRatio = turn / maxTurn;
            if (progressRatio <= 1/6) { tierNum = 1; tierKey = 'newcomer'; }
            else if (progressRatio <= 5/6) { tierNum = 2; tierKey = 'mid'; }
            else { tierNum = 3; tierKey = 'veteran'; }
            
            const eventFile = gameAssets.events[`${s.file}_${tierNum}`];

            let isH = false, dMsg = "", bCh = {}, out = 'success';

            if (activeIdx !== -1) {
                isH = false; isResultHidden = true; stopBgm = true;
                if (specialData[activeIdx]) {
                    dMsg = specialData[activeIdx].text;
                    bCh = specialData[activeIdx].changes;
                } else {
                    dMsg = "„Ç§„Éô„É≥„Éà„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ";
                    bCh = {};
                }
                out = 'exclusive'; 
            } else {
                let chance = isForcedHeroine ? 1.0 : (stats[assign.main] / 50) + (consecutiveNormalEvents * 0.1); 
                if (chance < 0.05) chance = 0.05; 
                if (lastEventWasHeroine && !isForcedHeroine) chance = 0;
                
                if (h.progress >= 5) { 
                    isH = true; lastEventWasHeroine = true; isResultHidden = true; stopBgm = true;
                    dMsg = "„ÄêÂæåÊó•Ë´á„Äë\n" + (h.afterMsg || "Á©è„ÇÑ„Åã„Å™ÊôÇÈñì„ÅåÊµÅ„Çå„Åü„ÄÇ"); 
                    bCh[assign.main] = 5; bCh[assign.sub] = 2; 
                    out = 'heroine'; 
                    lastEventContext = { name: h.name, progress: 6 }; 
                    if (!clearedHeroines.includes(h.name)) {
                        clearedHeroines.push(h.name);
                        localStorage.setItem('maghribal_cleared_heroines', JSON.stringify(clearedHeroines));
                    }
                } 
                else if (anyM && h.progress >= 1) { 
                    isH = true; lastEventWasHeroine = true; stopBgm = true;
                    dMsg = "„Äê‰∏ñÈñìË©±„Äë\n" + (h.chatMsg || "‰ΩïÊ∞ó„Å™„ÅÑ‰∏ñÈñìË©±„Çí„Åó„Å¶Âà•„Çå„Åü„ÄÇ"); 
                    bCh[assign.main] = 2; bCh[assign.sub] = 1; 
                    out = 'heroine'; 
                } 
                else if (Math.random() < chance) { 
                    const reqA = h.minAvg[Math.min(h.progress, 4)] || 0;
                    const reqS = (h.progress + 1) * 8;
                    const mIdx = h.progress < 2 ? 0 : 1; 
                    
                    if (avgStat < reqA) { 
                        isH = false; lastEventWasHeroine = false; 
                        dMsg = h.lockAvgMsgs[mIdx]; 
                        bCh[assign.main] = 1; bCh[assign.sub] = 1; 
                        out = 'hint'; 
                    } 
                    else if (stats[assign.main] < reqS) { 
                        isH = false; lastEventWasHeroine = false; 
                        dMsg = h.lockStatMsgs[mIdx]; 
                        bCh[assign.main] = 1; bCh[assign.sub] = 1; 
                        out = 'hint'; 
                    } 
                    else { 
                        isH = true; lastEventWasHeroine = true; consecutiveNormalEvents = 0; stopBgm = true;
                        dMsg = h.events[Math.min(h.progress, 4)]; 
                        h.progress++; h.affection++; 
                        if (h.progress >= 3) isResultHidden = true; 
                        bCh[assign.main] = 5; bCh[assign.sub] = 2; 
                        out = 'heroine'; 
                        lastEventContext = { name: h.name, progress: h.progress };
                        if (h.progress >= 5) {
                            if (!clearedHeroines.includes(h.name)) {
                                clearedHeroines.push(h.name);
                                localStorage.setItem('maghribal_cleared_heroines', JSON.stringify(clearedHeroines));
                            }
                        }
                    } 
                } 
                else { 
                    // ÈÄöÂ∏∏„Ç§„Éô„É≥„Éà„ÅÆÊäΩÈÅ∏
                    isH = false; lastEventWasHeroine = false; consecutiveNormalEvents++; 
                    
                    let pool = [];
                    // „Éá„Éº„ÇøÂΩ¢ÂºèÔºàÈÖçÂàóor„Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÔºâ„ÅÆËá™ÂãïÂà§Âà•„ÅØÁ∂≠ÊåÅ
                    if (Array.isArray(eventFile)) {
                        pool = eventFile;
                    } else if (eventFile && typeof eventFile === 'object') {
                        const tierData = eventFile[tierKey] || Object.values(eventFile)[0];
                        if (Array.isArray(tierData)) {
                            pool = tierData; 
                        } else if (tierData) {
                            pool = [].concat(tierData.success || [], tierData.failure || [], tierData.great || []);
                        }
                    }
                    
                    let targetPool = pool;
                    if (isRecommended) { 
                        const successPool = pool.filter(e => e.outcome !== 'failure'); 
                        if (successPool.length > 0) targetPool = successPool; 
                    } 
                    
                    // „Äê‰øÆÊ≠£„Äë„ÄåÈùô„Åã„Å™ÊôÇ„ÅåÊµÅ„Çå„Åü„Äç„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„ÇíÂâäÈô§
                    const ev = targetPool[Math.floor(Math.random() * targetPool.length)];
                    
                    // ev„ÅåÂèñÂæó„Åß„Åç„ÅüÂ†¥Âêà„ÅÆ„ÅøÂá¶ÁêÜ„ÇíÂÆüË°åÔºà„Å™„Åë„Çå„Å∞„Ç®„É©„ÉºÁ≠â„ÅßÊ≠¢„Åæ„ÇãÔºâ
                    if (ev) {
                        dMsg = ev.text; 
                        bCh = {...(ev.changes || {})}; 
                        out = ev.outcome; 
                        lastEventResult = out;
                        
                        // „ÄêÁ¢∫Ë™çÁî®„É≠„Ç∞„ÄëÊ≠£„Åó„ÅÑ„ÉÜ„Ç≠„Çπ„Éà„ÅåÂºï„Åë„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™çÁî®
                        console.log(`[EventCheck] File:${s.file}_${tierNum}, Key:${tierKey}, Text:${dMsg}`);
                    } else {
                        console.error(`[EventError] No event found for ${s.file}_${tierNum} (${tierKey})`);
                    }
                }
                
                if (isRecommended) { 
                    for (let k in bCh) { if (bCh[k] > 0) bCh[k] += 1; } 
                }
            }
            
            if (stopBgm) bgmMap.pause();
            
            // ev„ÅåÂèñÂæó„Åß„Åç„ÅödMsg„ÅåÁ©∫„ÅÆÂ†¥Âêà„ÄÅ„Ç¶„Ç£„É≥„Éâ„Ç¶Ë°®Á§∫„Åß„Åä„Åã„Åó„Åè„Å™„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„Åå„ÄÅ
            // „Äå„É≠„Ç∏„ÉÉ„ÇØ„ÇíÂÖ•„Çå„Å™„ÅÑ„ÄçÊñπÈáù„Å´Âæì„ÅÑ„Åù„ÅÆ„Åæ„ÅæÊ∏°„Åó„Åæ„Åô„ÄÇ
            applyEventView(dMsg, bCh, isH, h, s, out, idx);
        }        
        function getLocStatusHtml(idx) {
            let sec = defaultRegionStats[idx].sec; let eco = defaultRegionStats[idx].eco; activeImpacts.forEach((isActive, hId) => { if (isActive && heroineImpacts[hId].target === idx) { sec += heroineImpacts[hId].sec; eco += heroineImpacts[hId].eco; } }); sec = Math.max(1, Math.min(5, sec)); eco = Math.max(1, Math.min(5, eco)); const stars = (n) => '‚òÖ'.repeat(n) + '<span style=\"opacity:0.3\">‚òÖ</span>'.repeat(5-n); return `<span style=\"display:flex; align-items:center; color:#fff; text-shadow:-1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000, 0 0 3px #000;\"><i class=\"fa-solid fa-shield-halved\" style=\"color:#aaa; margin-right:4px;\"></i> ${stars(sec)}</span><span style=\"display:flex; align-items:center; color:#fff; text-shadow:-1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000, 0 0 3px #000;\"><i class=\"fa-solid fa-scale-balanced\" style=\"color:#d4af37; margin-right:4px;\"></i> ${stars(eco)}</span>`;
        }
        function applyEventView(msg, changes, isH, h, s, out, idx) {
            for (let k in changes) { stats[k] = Math.max(0, Math.min(stats[k] + (changes[k] || 0), 50)); updateUI(k); } checkRankUpdate(); 
            let cLog = isResultHidden ? "" : getResultHtml(changes); 
            let outcomeHtml = ""; 
            if (!isH && out !== 'hint' && out !== 'heroine' && out !== 'exclusive') { 
                if (out === 'great_success' || out === 'great') outcomeHtml = `<span class=\"outcome-badge great\">„ÄêÂ§ßÊàêÂäü„Äë</span>`; 
                else if (out === 'success') outcomeHtml = `<span class=\"outcome-badge success\">„ÄêÊàêÂäü„Äë</span>`; 
                else if (out === 'failure') outcomeHtml = `<span class=\"outcome-badge failure\">„ÄêÂ§±Êïó„Äë</span>`; 
            } 
            let logL = isH ? `(<i class=\"fa-solid ${h ? h.icon : ''}\"></i> ${h ? h.name : ''})` : ""; const locLabel = `<i class=\"fa-solid ${s.icon}\"></i> ${s.name}`; currentGameLog.push(`<div class=\"log-entry\"><div class=\"log-header\">Turn ${turn} : ${locLabel} ${logL} ${outcomeHtml} ${getResultHtml(changes)}</div><div class=\"log-body\">${formatGameText(msg).replace(/\n/g, '<br>')}</div></div>`); document.getElementById("log-content").innerHTML = currentGameLog.join(''); document.getElementById("background-layer").style.transformOrigin = `${spotAssignments[idx].l}% ${spotAssignments[idx].t}%`; document.getElementById("background-layer").style.transform = `scale(${s.zoom || 2.5})`; document.getElementById("background-layer").classList.add("blur-bg"); 
            
            if (typeof msg === 'string') {
                messageQueue = msg.split('\n').filter(line => line.trim() !== "");
            } else {
                messageQueue = Array.isArray(msg) ? msg : [msg];
            }
            
            currentMsgIndex = 0; isResultDisplayed = false; pendingResultHtml = outcomeHtml + cLog; document.getElementById("loc-icon").innerHTML = `<i class=\"fa-solid ${s.icon}\"></i>`; document.getElementById("loc-name").innerText = s.name; document.getElementById("loc-stats").innerHTML = getLocStatusHtml(idx); const cb = document.getElementById("char-name-badge"); if (isH && h) { cb.innerHTML = `<i class=\"fa-solid ${h.icon}\"></i> ${h.title} ${h.name}`; cb.style.display = "flex"; } else cb.style.display = "none"; document.getElementById("message-text").innerHTML = ""; document.getElementById("result-display").innerHTML = ""; document.getElementById("result-display").style.opacity = "0"; document.getElementById("page-cursor").classList.remove("active"); document.getElementById("message-window").classList.add("active"); document.getElementById("click-overlay").classList.add("active"); setTimeout(advanceMessage, 300);
        }
        function advanceMessage() { 
            const cursor = document.getElementById("page-cursor"); 
            if (isTyping) { finishTyping(); return; } 
            if (currentMsgIndex < messageQueue.length) { 
                cursor.classList.remove("active"); targetText = messageQueue[currentMsgIndex++]; typeWriter(document.getElementById("message-text"), targetText, 15); 
            } else {
                if (isResultHidden) { closeEvent(); } else if (!isResultDisplayed) { cursor.classList.remove("active"); showFinalResult(); cursor.classList.add("active"); } else { cursor.classList.remove("active"); closeEvent(); }
            }
        }
        function typeWriter(el, text, speed) { 
            let i = 0; el.innerHTML = ""; isTyping = true; 
            targetText = text; 
            typeInterval = setInterval(() => { 
                if (i < text.length) { 
                    // „Äê‰øÆÊ≠£„Äë„Çø„Ç∞(@xxx@)„ÅÆÈñãÂßã„ÇíÊ§úÁü•„Åó„Åü„Çâ„ÄÅÈñâ„Åò„Çø„Ç∞„Åæ„Åß‰∏ÄÊ∞ó„Å´„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÇíÈÄ≤„ÇÅ„Çã
                    // „Åì„Çå„Å´„Çà„Çä„ÄÅ"@fame@" „ÅÆ„Çà„ÅÜ„Å™ÈÄî‰∏≠ÁµåÈÅé„ÅåË°®Á§∫„Åï„Çå„Åö„ÄÅÂç≥Â∫ß„Å´ "ÂêçÂ£∞" „Å®Â§âÊèõ„Åï„Çå„Å¶Ë°®Á§∫„Åï„Çå„Åæ„Åô
                    if (text[i] === '@') {
                        const match = text.substring(i).match(/^@(\w+)@/);
                        if (match) {
                            i += match[0].length - 1; // „Çø„Ç∞„ÅÆÊú´Â∞æ„Åæ„Åß„Çπ„Ç≠„ÉÉ„Éó
                        }
                    }

                    el.innerHTML = formatGameText(text.substring(0, i + 1)); 
                    i++; 
                } else { 
                    finishTyping(); 
                } 
            }, speed); 
        }
        function finishTyping() { 
            clearInterval(typeInterval); 
            isTyping = false; 
            document.getElementById("message-text").innerHTML = formatGameText(targetText);
            document.getElementById("page-cursor").classList.add("active"); 
        }
        function showFinalResult() { playSE(sePage); const resDiv = document.getElementById("result-display"); resDiv.innerHTML = pendingResultHtml; resDiv.style.opacity = "1"; isResultDisplayed = true; document.getElementById("page-cursor").classList.add("active"); }
        function getResultHtml(changes) { let h = ''; for (let k in changes) { if (changes[k] !== 0) { const arrow = changes[k] > 0 ? `<span style=\"color:#76ff03; font-size:0.8em;\">‚ñ≤</span>` : `<span style=\"color:#ea80fc; font-size:0.8em;\">‚ñº</span>`; h += `<span style=\"color:${statColors[k]}; margin:0 8px; font-weight:bold; white-space:nowrap;\"><i class=\"fa-solid ${statConfig[k].icon}\"></i> ${statConfig[k].name}${arrow}</span>`; } } return h; }
        
        function closeEvent() { 
            document.getElementById("background-layer").style.transform = "scale(1)"; document.getElementById("background-layer").classList.remove("blur-bg"); document.getElementById("message-window").classList.remove("active"); document.getElementById("click-overlay").classList.remove("active"); document.getElementById("page-cursor").classList.remove("active"); 
            if (bgmMap.paused && activeImpacts.findIndex(Boolean) === -1) bgmMap.play();

            const activeIdx = activeImpacts.findIndex(Boolean);
            if (activeIdx !== -1) { 
                document.getElementById('fade-overlay').classList.add('active'); bgmMap.pause(); setTimeout(showEnding, 1500); 
                return; 
            }
            
            if (turn < maxTurn) { 
                turn++; 
                document.getElementById("turn-count").innerText = turn; 
                isEventActive = false; 
                updateMonologue(); 
                saveSessionData(); 
                
                setTimeout(() => { 
                     document.querySelectorAll('.map-spot').forEach(s => { s.classList.add('spot-visible'); s.querySelector('.hint-text').classList.remove('selected-yellow'); }); 
                }, 250);
            } 
            else { 
                updateMonologue(); 
                saveSessionData(); 
                setTimeout(() => { document.getElementById('fade-overlay').classList.add('active'); bgmMap.pause(); setTimeout(showEnding, 3000); }, 3000);
            }
        }
        function formatGameText(text) { return text.replace(/@(\w+)@/g, (m, k) => `<span style=\"color:${statColors[k]}\">${statConfig[k].name}</span>`); }
        function toggleStats() { playSE(sePi); const p = document.getElementById("stats-panel"); p.style.display = p.style.display === "block" ? "none" : "block"; }
        function toggleLog() { playSE(sePi); const l = document.getElementById("log-overlay"); l.style.display = l.style.display === "flex" ? "none" : "flex"; if(l.style.display === "flex") { document.getElementById("log-window").scrollTop = document.getElementById("log-window").scrollHeight; } }
        function checkRankUpdate() { const total = Object.values(stats).reduce((sum, v) => sum + v, 0), btn = document.getElementById("status-toggle-btn"); let rank = total >= 150 ? "legend" : (total >= 100 ? "gold" : (total >= 50 ? "silver" : "bronze")); [btn, document.getElementById("stats-panel")].forEach(el => { if(el) { el.classList.remove("rank-silver", "rank-gold", "rank-legend"); if (rank !== "bronze") el.classList.add("rank-" + rank); } }); }
        
        function renderBoostButtons() { 
            const container = document.getElementById("boost-container"); if(!container) return; container.innerHTML = ""; 
            
            const title = document.createElement("div");
            title.className = "boost-section-title";
            title.innerText = "- START BONUS / WORLD INFLUENCE -";
            container.appendChild(title);

            const content = document.createElement("div");
            content.className = "boost-section";
            
            statKeys.forEach(k => { const btn = document.createElement("button"); btn.className = `boost-btn ${unlockedBoosts[k] ? 'unlocked' : ''} ${activeBoosts[k] ? 'active' : ''}`; btn.innerHTML = `<i class=\"fa-solid ${statConfig[k].icon}\"></i> ${statConfig[k].name} +10`; btn.onclick = (e) => { e.stopPropagation(); if(!unlockedBoosts[k]) return; activeBoosts[k] = !activeBoosts[k]; localStorage.setItem('maghribal_active_boosts', JSON.stringify(activeBoosts)); playSE(sePi); renderBoostButtons(); }; content.appendChild(btn); });
            
            const divider = document.createElement("div");
            divider.className = "boost-divider";
            content.appendChild(divider);

            heroines.forEach((h, i) => { const impact = heroineImpacts[i]; const targetScene = scenarios[impact.target]; const isActive = activeImpacts[i]; 
            const isUnlocked = clearedHeroines.includes(h.name); 
            const btn = document.createElement("button"); btn.className = `boost-btn ${isUnlocked ? 'unlocked' : ''} ${isActive ? 'active' : ''}`; 
            btn.innerHTML = `<i class=\"fa-solid ${targetScene.icon}\"></i> ${impact.btnLabel}`; 
            btn.onclick = (e) => { e.stopPropagation(); if (!isUnlocked) return; const wasActive = activeImpacts[i]; activeImpacts.fill(false); if (!wasActive) activeImpacts[i] = true; localStorage.setItem('maghribal_active_impacts', JSON.stringify(activeImpacts)); playSE(sePi); renderBoostButtons(); }; content.appendChild(btn); });

            container.appendChild(content);
        }
        
        function saveCurrentGameLog() { 
            const activeIdx = activeImpacts.findIndex(Boolean); if (activeIdx !== -1) return; 
            const total = Object.values(stats).reduce((sum, v) => sum + v, 0); const rank = total >= 150 ? "LEGEND" : (total >= 100 ? "GOLD" : (total >= 50 ? "SILVER" : "BRONZE")); const best = heroines.reduce((a, b) => a.affection > b.affection ? a : b); let partnerHTML = ""; if (best && best.affection > 0) { const hIcon = `<i class=\"fa-solid ${best.icon}\" style=\"font-size:0.9em; opacity:0.8;\"></i> `; let affinityHTML = ""; if (best.progress >= 5) affinityHTML = ` <i class=\"fa-solid fa-mound bouquet-icon\" style=\"font-size:0.8em;\"></i>`; else if (best.progress >= 3) affinityHTML = ` <i class=\"fa-solid fa-seedling affinity-seedling\" style=\"font-size:0.8em;\"></i>`; else affinityHTML = ` <i class=\"fa-solid fa-leaf affinity-leaf\" style=\"font-size:0.8em;\"></i>`; partnerHTML = `${hIcon}${best.name}${affinityHTML}`; } else { const maxK = [...statKeys].sort((a, b) => stats[b] - stats[a])[0]; partnerHTML = soloTitles[maxK]; } const now = new Date(); const dateStr = (now.getMonth()+1) + "/" + now.getDate() + " " + now.getHours() + ":" + now.getMinutes().toString().padStart(2, '0'); const newRecord = { date: dateStr, rank: rank, partnerHTML: partnerHTML, log: currentGameLog.join('') }; let records = JSON.parse(localStorage.getItem('maghribal_logs') || "[]"); records.push(newRecord); if (records.length > 10) records.shift(); localStorage.setItem('maghribal_logs', JSON.stringify(records)); displayPastRecords(); 
        }
        function showEnding() { 
            processBoostUnlock(); 
            if (activeImpacts.findIndex(Boolean) === -1) saveCurrentGameLog();
            
            localStorage.removeItem('maghribal_resume_data'); 

            document.getElementById("ed-screen").classList.remove("hidden-screen"); 
            bgmMap.pause(); bgmEd.currentTime = 0; bgmEd.play();
            
            const activeIdx = activeImpacts.findIndex(Boolean);
            if (activeIdx !== -1) {
                document.getElementById("ed-rank").innerText = "SPECIAL EPISODE CLEAR";
                const h1 = heroines[activeIdx];
                const tIdx = heroineImpacts[activeIdx].target;
                const scene = scenarios[tIdx];
                const h2 = heroines.find(h => h.file === scene.file) || heroines[tIdx];
                const partnerHTML = `<span style=\"display:flex; align-items:center; gap:8px;\"><i class=\"fa-solid ${h1.icon}\"></i> ${h1.name} <span style=\"font-size:0.8em; opacity:0.7;\">+</span> <i class=\"fa-solid ${scene.icon}\"></i> ${scene.name} <span style=\"font-size:0.8em; opacity:0.7;\">+</span> <i class=\"fa-solid ${h2.icon}\"></i> ${h2.name}</span>`;
                document.getElementById("ed-heroine").innerHTML = partnerHTML;
                document.getElementById("ed-stats").innerHTML = ""; 
            } else {
                const total = Object.values(stats).reduce((sum, v) => sum + v, 0); let rank = total >= 150 ? "LEGEND" : (total >= 100 ? "GOLD" : (total >= 50 ? "SILVER" : "BRONZE")); document.getElementById("ed-rank").innerText = `Rank: ${rank}`; let best = heroines.reduce((a, b) => a.affection > b.affection ? a : b); let endingDisplay = ""; if (best && best.affection > 0) { const hIcon = `<i class=\"fa-solid ${best.icon}\" style=\"margin:0 10px;\"></i>`; let affinityIcon = ""; if (best.progress >= 5) affinityIcon = `<span class=\"affinity-icon bouquet-icon\"><i class=\"fa-solid fa-mound\"></i></span>`; else if (best.progress >= 3) affinityIcon = `<span class=\"affinity-icon affinity-seedling\" style=\"margin-left:8px;\"><i class=\"fa-solid fa-seedling\"></i></span>`; else affinityIcon = `<span class=\"affinity-icon affinity-leaf\" style=\"margin-left:8px;\"><i class=\"fa-solid fa-leaf\"></i></span>`; endingDisplay = `Partner: ${hIcon} ${best.name}${affinityIcon}`; } else { const maxK = [...statKeys].sort((a, b) => stats[b] - stats[a])[0]; endingDisplay = `Áß∞Âè∑: ${soloTitles[maxK]}`; } document.getElementById("ed-heroine").innerHTML = endingDisplay; let h = ""; statKeys.forEach(k => { const val = Math.floor(stats[k]); const isMax = val >= 50; const color = statColors[k]; const borderStyle = isMax ? `border: 2px solid ${color}; box-shadow: 0 0 10px ${color};` : ""; const iconStyle = isMax ? `color: ${color};` : ""; const maxLabel = isMax ? `<span class=\"max-label\" style=\"color:${color}\">MAX</span>` : ""; h += `<div class=\"ed-stat-box\" style=\"${borderStyle}\"><i class=\"fa-solid ${statConfig[k].icon}\" style=\"${iconStyle}\"></i><div style=\"font-size:9px; color:#ccc;\">${statConfig[k].name}</div><span class=\"ed-stat-val\">${val}</span>${maxLabel}</div>`; }); document.getElementById("ed-stats").innerHTML = h; 
            }
            setTimeout(() => { document.getElementById('fade-overlay').classList.remove('active'); }, 500);
        }
        function displayPastRecords() { const records = JSON.parse(localStorage.getItem('maghribal_logs') || "[]"); const container = document.getElementById("past-records-list"); if (!container) return; if (records.length === 0) { container.innerHTML = "<div style='font-size:10px; color:#666; padding:10px; text-align:center;'>NO RECORDS YET.</div>"; return; } container.innerHTML = records.slice().reverse().map((rec, idx) => `<div class=\"record-item\" onclick=\"viewSpecificLog(${records.length - 1 - idx})\"><span class=\"record-rank\" style=\"color:${rankColors[rec.rank] || '#fff'}\">[${rec.rank}]</span><span class=\"record-partner\">${rec.partnerHTML}</span><span class=\"record-date\">${rec.date}</span></div>`).join(''); }
        function startOP() { 
            seOp.currentTime = 0; seOp.play(); 
            resizeGameContainer(); currentGameLog = []; document.getElementById("log-content").innerHTML = ""; 
            const activeIdx = activeImpacts.findIndex(Boolean);
            if (activeIdx !== -1) { statKeys.forEach(k => { stats[k] = 0; updateUI(k); }); } else { statKeys.forEach(k => { stats[k] = activeBoosts[k] ? 10 : 0; updateUI(k); }); }
            bgmOp.pause(); bgmOp.currentTime = 0; bgmOp.play(); 
            document.getElementById("title-screen").classList.add("hidden-screen"); 
            setTimeout(() => { document.getElementById("op-screen").classList.remove("hidden-screen"); 
            const opLines = (activeIdx !== -1) ? heroineOPLines[activeIdx] : ["ÈôΩ„ÅåÊ≤à„ÇÄË•ø„ÅÆÂú∞„ÄÅ„Éû„Ç∞„É™„Éê„É´„ÄÇ", "„Åì„Åì„Å´„ÅØÂêçÂ£∞„ÄÅÂØå„ÄÅÁü•Ë≠ò„ÄÅ„Åù„Åó„Å¶Âäõ„ÅåÁú†„Å£„Å¶„ÅÑ„Çã„ÄÇ", "ÊÆã„Åï„Çå„ÅüÊôÇÈñì„ÅØ„ÄÅ„Åù„ÅÜÈï∑„Åè„ÅØ„Å™„ÅÑ„ÄÇ", "„Å©„ÅÆÈÅì„ÇíÊ≠©„Åø„ÄÅ‰ΩïËÄÖ„Å®„Å™„Çã„Åã„ÄÇ", "ÂÖ®„Å¶„ÅØÊ±ù„ÅÆÈÅ∏Êäû„Å´Âßî„Å≠„Çâ„Çå„Å¶„ÅÑ„Çã„ÄÇ"];
            updateMapState(); 
            
            let idx = 0; const opDiv = document.getElementById("op-text"); const showLine = () => { opDiv.style.opacity = 0; setTimeout(() => { opDiv.innerHTML = opLines[idx]; opDiv.style.opacity = 1; }, 400); }; showLine(); window.nextOP = () => { idx++; if (idx < opLines.length) showLine(); else { 
                document.getElementById("op-screen").classList.add("hidden-screen"); document.getElementById("top-ui-container").style.display = "flex"; document.getElementById("background-layer").classList.add("visible"); 
                bgmOp.pause(); bgmMap.currentTime = 0; bgmMap.play();
                setTimeout(() => { 
                    document.querySelectorAll('.map-spot').forEach(s => s.classList.add('spot-visible')); 
                    updateMonologue('start');
                    isGameStarted = true; 
                }, 1000); 
            } }; }, 500); 
        }
        function processBoostUnlock() { const sortedKeys = [...statKeys].sort((a, b) => stats[b] - stats[a]); for (let key of sortedKeys) { if (!unlockedBoosts[key]) { unlockedBoosts[key] = true; localStorage.setItem('maghribal_boosts', JSON.stringify(unlockedBoosts)); break; } } }
        function viewSpecificLog(idx) { const records = JSON.parse(localStorage.getItem('maghribal_logs') || "[]"); const rec = records[idx]; if (rec) { const logWindow = document.getElementById("log-window"); document.getElementById("log-content").innerHTML = rec.log; toggleLog(); logWindow.scrollTop = 0; } }
        function toggleDebugPanel() { const p = document.getElementById("debug-panel"); p.style.display = p.style.display === "block" ? "none" : "block"; if(p.style.display === "block") { renderHeroineSliders(); initDebugEventTester(); } }
        function debugModTurn(amount) { turn = Math.max(1, Math.min(maxTurn, turn + amount)); updateMapState(); }
        function initDebugEventTester() { const m = document.getElementById("debug-map-select"); if (m.options.length > 0) return; scenarios.forEach((s, i) => { const o = document.createElement("option"); o.value = i; o.innerText = s.name; m.appendChild(o); }); updateDebugEventList(); }
        
function updateDebugEventList() { 
            const mIdx = document.getElementById("debug-map-select").value; 
            const eS = document.getElementById("debug-event-select"); 
            
            const progress = turn / maxTurn; 
            const tNum = progress <= 1/6 ? 1 : (progress <= 5/6 ? 2 : 3); 
            const tKey = progress <= 1/6 ? 'newcomer' : (progress <= 5/6 ? 'mid' : 'veteran');
            
            const poolObj = gameAssets.events[`${scenarios[mIdx].file}_${tNum}`][tKey]; 
            eS.innerHTML = ""; 
            
            // „Äê‰øÆÊ≠£ÁÆáÊâÄ„Äë„Åì„Åì„Åß„ÇÇÈÖçÂàóÁµêÂêà„ÇíË°å„ÅÑ„Åæ„Åô
            const pool = [].concat(poolObj.success || [], poolObj.failure || [], poolObj.great || []);
            
            pool.forEach((ev, i) => { 
                const o = document.createElement("option"); 
                o.value = i; 
                o.innerText = `[${tKey}] ${ev.text.substring(0, 30)}...`; 
                eS.appendChild(o); 
            }); 
        }
function launchDebugTestEvent() { 
            const mIdx = document.getElementById("debug-map-select").value; 
            const eIdx = document.getElementById("debug-event-select").value; 
            const s = scenarios[mIdx]; 
            
            const progress = turn / maxTurn; 
            const tNum = progress <= 1/6 ? 1 : (progress <= 5/6 ? 2 : 3); 
            const tKey = progress <= 1/6 ? 'newcomer' : (progress <= 5/6 ? 'mid' : 'veteran');
            
            const poolObj = gameAssets.events[`${s.file}_${tNum}`][tKey];
            
            // „Äê‰øÆÊ≠£ÁÆáÊâÄ„Äë„Åì„Åì„Åß„ÇÇÈÖçÂàóÁµêÂêà„ÇíË°å„Å£„Å¶„Åã„Çâ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„Ç¢„ÇØ„Çª„Çπ„Åó„Åæ„Åô
            const pool = [].concat(poolObj.success || [], poolObj.failure || [], poolObj.great || []);
            
            const ev = pool[eIdx]; 
            if(!ev) return; 
            
            isEventActive = true; 
            isResultDisplayed = false; 
            applyEventView(ev.text, ev.changes||{}, false, null, s, ev.outcome, mIdx); 
        }
        function renderHeroineSliders() { const c = document.getElementById("debug-heroine-sliders"); c.innerHTML = ""; heroines.forEach((h, i) => { const d = document.createElement("div"); d.innerHTML = `<div style=\"font-size:12px; margin-bottom:5px;\">${h.title} ${h.name} Lv.<span id=\"h-lv-${i}\">${h.progress}</span></div><input type=\"range\" min=\"0\" max=\"5\" value=\"${h.progress}\" style=\"width:100%\" oninput=\"heroines[${i}].progress=parseInt(this.value); heroines[${i}].affection=parseInt(this.value); document.getElementById('h-lv-${i}').innerText=this.value\">`; c.appendChild(d); }); }
        function debugResetAllData() { if(confirm("ÂÖ®Ê∂àÂéª„Åó„Åæ„Åô„ÅãÔºü")) { localStorage.clear(); location.reload(); } }
        function debugMaxStats() { statKeys.forEach(k => { stats[k] = 50; updateUI(k); }); checkRankUpdate(); }
        function debugFinishGame() { document.getElementById('fade-overlay').classList.add('active'); bgmMap.pause(); setTimeout(showEnding, 1500); }
        function debugToggleBoosts() { 
            const isL = statKeys.some(k => !unlockedBoosts[k]); 
            statKeys.forEach(k => { unlockedBoosts[k] = isL; }); 
            if (isL) { clearedHeroines = heroines.map(h => h.name); } else { clearedHeroines = []; }
            localStorage.setItem('maghribal_boosts', JSON.stringify(unlockedBoosts)); 
            localStorage.setItem('maghribal_cleared_heroines', JSON.stringify(clearedHeroines)); 
            renderBoostButtons(); 
        }
        function toggleForceHeroine() { isForcedHeroine = !isForcedHeroine; document.getElementById("force-heroine-btn").innerText = isForcedHeroine ? "‚ô• Force Heroine: ON" : "‚ô• Force Heroine: OFF"; document.getElementById("force-heroine-btn").classList.toggle("active", isForcedHeroine); }
    </script>
</body>
</html>
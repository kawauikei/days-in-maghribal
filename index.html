<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Days in Maghribal - Polish Ver</title>
    <link rel="icon" href="data:,">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <script src="js/game_data.js"></script>
    <script src="js/audio.js"></script>
    <script src="js/debug.js"></script>
    <script src="js/ui.js"></script>
</head>
<body>
    <svg style="position:fixed; top:-100%; left:-100%; width:0; height:0;">
        <filter id="water-filter">
            <feTurbulence type="fractalNoise" baseFrequency="0.015 0.015" numOctaves="3" seed="1" result="noise">
                <animate attributeName="baseFrequency" dur="15s" values="0.015 0.015;0.02 0.03;0.015 0.015" repeatCount="indefinite" />
            </feTurbulence>
            <feDisplacementMap in="SourceGraphic" in2="noise" scale="20" />
        </filter>
    </svg>

    <div id="fade-overlay"></div>

    <div id="loading-screen">
        <div style="font-size: 24px; letter-spacing: 5px;">LOADING ASSETS</div>
        <div id="load-bar-container"><div id="load-bar-fill"></div></div>
        <div id="load-status">Initializing...</div>
    </div>

    <div id="debug-toggle-btn" onclick="toggleDebugPanel()"><i class="fa-solid fa-gear"></i></div>
    <div id="debug-panel">
        <div style="font-size: 10px; color: #ffcc00; margin-bottom: 5px; border-bottom: 1px solid #444;">DATA CONTROL</div>
        <button class="debug-btn" onclick="debugResetAllData()" style="color: #ff4d4d;">â†º Reset All Data</button>
        <button class="debug-btn" onclick="debugToggleBoosts()" id="debug-boost-btn">ğŸ”“ Unlock Boosts</button>
        <div style="font-size: 10px; color: #ffcc00; margin: 10px 0 5px; border-bottom: 1px solid #444;">TURN CONTROL</div>
        <div class="debug-row">
            <button class="debug-btn" onclick="debugModTurn(-5)">-5</button>
            <button class="debug-btn" onclick="debugModTurn(-1)">-1</button>
            <button class="debug-btn" onclick="debugModTurn(1)">+1</button>
            <button class="debug-btn" onclick="debugModTurn(5)">+5</button>
        </div>
        <div style="font-size: 10px; color: #ffcc00; margin: 10px 0 5px; border-bottom: 1px solid #444;">EVENT TESTER</div>
        <div style="display: flex; flex-direction: column; gap: 3px; margin-bottom: 5px;">
            <select id="debug-map-select" onchange="updateDebugEventList()" style="background: #222; color: #fff; font-size: 10px; border: 1px solid #b08d55;"></select>
            <select id="debug-event-select" style="background: #222; color: #fff; font-size: 10px; border: 1px solid #b08d55;"></select>
        </div>
        <button class="debug-btn" onclick="launchDebugTestEvent()" style="width: 100%; background: #b08d55; color: #000;">âš¡ Launch Test</button>
        <div style="font-size: 10px; color: #ffcc00; margin: 10px 0 5px; border-bottom: 1px solid #444;">HEROINE PROGRESS</div>
        <div id="debug-heroine-sliders" style="background: rgba(0,0,0,0.3); padding: 5px; border-radius: 4px;"></div>
        <div style="font-size: 10px; color: #ffcc00; margin: 10px 0 5px; border-bottom: 1px solid #444;">GAMEPLAY</div>
        <button class="debug-btn" onclick="debugMaxStats()">â˜… Max</button>
        <button class="debug-btn" onclick="debugFinishGame()">ğŸ Finish</button>
        <button id="force-heroine-btn" class="debug-btn" onclick="toggleForceHeroine()">â™¥ Force: OFF</button>
    </div>

    <div id="game-container">
        <div id="background-layer"></div>
        
        <div id="monologue-container"><div class="monologue-text"></div></div>

        <div id="map-spots-container"></div>
        
        
        <div id="top-ui-container">
            <div id="turn-display"><span style="margin-right:15px; font-weight:bold;"><i class="fa-solid fa-hourglass-start"></i> TURN</span><span id="turn-count">1</span>/20</div>
            <button id="status-toggle-btn" class="ui-btn" onclick="toggleStats()">STATUS</button>
            <button id="log-btn" class="ui-btn" onclick="toggleLog()">LOG</button>
            <button id="fullscreen-btn" class="fullscreen-btn" onclick="toggleFullScreen()"><i class="fa-solid fa-expand"></i></button>
        </div>

        <div id="stats-panel"><div id="stat-list"></div></div>
        <div id="log-overlay"><div id="log-window"><div id="log-content"></div></div><button class="ui-btn" onclick="toggleLog()">CLOSE</button></div>
        
        <div id="click-overlay" onclick="advanceMessage()"></div>
        <div id="message-window" onclick="advanceMessage()">
            <div id="location-badge">
                <span id="loc-icon"></span><span id="loc-name"></span>
                <span id="loc-stats"></span>
            </div>
            <div id="char-name-badge"></div>
            <div id="message-text"></div>
            <div id="result-display"></div>
            <div id="page-cursor"><i class="fa-solid fa-caret-down"></i></div>
        </div>
        
        <div id="title-screen" class="overlay-screen">
            <div id="title-img-bg" style="background-image: url('images/title.png');"></div>
            <button id="title-fullscreen-btn" class="fullscreen-btn" onclick="toggleFullScreen()"><i class="fa-solid fa-expand"></i></button>
            
            <div class="title-logo-wrapper">
                <div class="title-logo-container">
                    <h1 class="size-days">DAYS</h1><h1 class="size-in">IN</h1><h1 class="size-magh">MAGHRIBAL</h1>
                </div>
                <div class="title-underline"></div>
                <h2 class="jp-title">- ãƒã‚°ãƒªãƒãƒ«ã«ã¦ -</h2>
            </div>

            <div class="title-btn-container">
                <button id="start-btn" onclick="startOP()">GAME START</button>
                <button id="continue-btn" onclick="continueGame()">CONTINUE</button>
            </div>

            <div id="boost-container"></div>
            <div id="past-records-container">
                <div class="record-title"><i class="fa-solid fa-clock-rotate-left"></i> PAST RECORDS</div>
                <div id="past-records-list"></div>
            </div>
        </div>

        <div id="op-screen" class="overlay-screen hidden-screen" onclick="nextOP()">
            <div id="op-text"></div><div style="position:absolute; bottom:30px;"><i class="fa-solid fa-caret-down" style="font-size:24px; color:#b08d55; animation:cursorBlink 1s infinite alternate;"></i></div>
        </div>

        <div id="ed-screen" class="overlay-screen hidden-screen">
            <div id="ed-rank"></div>
            <div id="ed-heroine" style="color:#ffcc00; font-weight:bold; margin-bottom:20px; display: flex; justify-content: center; align-items: center; gap: 4px;"></div>
            <div id="ed-msg"></div>
            <div id="ed-stats"></div>
            <div style="display:flex; gap:20px; align-items:center;">
                <button id="ed-log-btn" onclick="toggleLog()">REVIEW LOG</button>
                <button id="retry-btn" onclick="retryGame()">RETRY</button>
            </div>
        </div>
    </div>

    <script>
        const impactConfig = {
            "ã‚ªãƒ«ãƒ†ãƒ³ã‚·ã‚¢": { targetName: "è¾ºå¢ƒã®æ‘", sec: 1, eco: 1, name: "ç‹å®¶ã®é…çµ¦" },
            "ã‚¨ãƒ«ãƒŠ": { targetName: "é™è¬ãªä¿®é“é™¢", sec: 1, eco: 0, name: "åç©«ã®ç¥ˆã‚Š" },
            "ã‚·ãƒ«ãƒ•ã‚£ã‚¨ãƒƒãƒˆ": { targetName: "è³¢è€…ã®å¡”", sec: 0, eco: 0, name: "å¤æ›¸ã®å¯„è´ˆ" },
            "ãƒ«ãƒŠãƒªã‚¹": { targetName: "è¿·å®®ã®å…¥ã‚Šå£", sec: -1, eco: 1, name: "æ·±æ·µã®è§£æ˜" },
            "ãƒãƒªãƒ¼ãƒŠ": { targetName: "å…­è§’ã®ç‹éƒ½", sec: -1, eco: 1, name: "é—‡å¸‚å ´" },
            "ã‚«ã‚¿ãƒªãƒŠ": { targetName: "è³‘ã‚ã„ã®æ¸¯ç”º", sec: 1, eco: -1, name: "æµ·è³Šç‹©ã‚Š" },
            "ã‚¨ãƒªã‚¹ãƒ•ã‚§ãƒªã‚¢": { targetName: "å¤ªå¤ã®å¢“åœ°", sec: 1, eco: 1, name: "ç²¾éœŠç¥­" },
            "ãƒ¬ã‚°ãƒªãƒŠ": { targetName: "å–§é¨’ã®é—˜æŠ€å ´", sec: -1, eco: 1, name: "çœŸå¤œä¸­" },
            "ã‚¼ãƒ•ã‚¡ãƒ¼": { targetName: "ç·‘ã®éš ã‚Œé‡Œ", sec: 1, eco: 1, name: "ç•°æ–‡åŒ–" },
            "ãƒ¡ãƒ«ãƒ«": { targetName: "å·¨å²©ã®è¦å¡", sec: 0, eco: 0, name: "å‚­å…µå›£" },
            "ãƒã‚¯ãƒ­ã‚¢": { targetName: "å¿˜ã‚Œã‚‰ã‚ŒãŸå¤åŸ", sec: -1, eco: 1, name: "å¹»å½±ã®ç¥å®´" },
            "ã‚¨ãƒ«ãƒ´ã‚£ãƒ¼ãƒ©": { targetName: "çœŸé®ã®è’é‡", sec: 1, eco: 0, name: "ç ‚æ¼ ã®èŠ±" }
        };
        
        let heroineImpacts = []; 
        let isResultHidden = false;
        let lastEventContext = null; 
        let lastEventResult = null;
        let monologueInterval;
        let specialData = []; 
        let monologueData = {}; 
        let heroineReactions = {}; 
        let clearedHeroines = [];

        const heroineOPLines = [
            ["ç‹éƒ½ã®å¨å…‰ãŒè¾ºå¢ƒã‚’ç…§ã‚‰ã™ã€‚", "ç‹å¥³ã®å‘½ã«ã‚ˆã‚Šã€è²§ã—ãæ‘ã«ç‰©è³‡ãŒå±Šã‘ã‚‰ã‚ŒãŸã€‚", "å¸Œæœ›ã®å…‰ãŒã€äººã€…ã®ç³ã«å®¿ã‚Šå§‹ã‚ã‚‹ã€‚"], 
            ["è³¢è€…ã®å¡æ™ºãŒã€è¿·å®®ã®æ·±æ·µã‚’ç…§ã‚‰ã™ã€‚", "å°å°ãŒè§£ã‹ã‚Œã€å†’é™ºè€…ãŸã¡ãŒæ·±å±¤ã¸ã¨æŒ‘ã‚€ã€‚", "å±é™ºã¨éš£ã‚Šåˆã‚ã›ã®ã€å¯Œã¸ã®æ‰‰ãŒé–‹ã‹ã‚ŒãŸã€‚"],
            ["è¾ºå¢ƒã®å®Ÿã‚ŠãŒã€ä¿®é“é™¢ã®é£Ÿå“ã‚’æº€ãŸã™ã€‚", "æ‘äººãŸã¡ãŒå±Šã‘ãŸæ–°é®®ãªç³§ãŒã€ç¥ˆã‚Šã®å ´ã‚’æ”¯ãˆã‚‹ã€‚", "ã•ã•ã‚„ã‹ãªå¹¸ç¦ãŒã€é™ã‹ã«æº€ã¡ã¦ã„ãã€‚"],
            ["ç¦å¿Œã®çŸ¥è­˜ãŒã€å¡”ã®å¤œã‚’æ€ªã—ãç…§ã‚‰ã™ã€‚", "å¤åŸã‹ã‚‰æŒã¡è¾¼ã¾ã‚ŒãŸå¤æ–‡æ›¸ãŒã€è³¢è€…ãŸã¡ã‚’ç†±ç‹‚ã•ã›ã‚‹ã€‚", "çŸ¥ã®äº¤æµãŒã€æ–°ãŸãªç™ºè¦‹ã‚’ç”Ÿã‚€ã€‚"],
            ["æ¸¯ã®ç†±æ°—ãŒã€ç‹éƒ½ã®å¤œã‚’å½©ã‚‹ã€‚", "æµ·ã‹ã‚‰ã®çå“ãŒé—‡å¸‚å ´ã«æº¢ã‚Œã€è²´æ—ãŸã¡ã‚’é­…äº†ã™ã‚‹ã€‚", "æ¬²æœ›ã¨é‡‘è²¨ãŒã€è¡—ã®å½±ã§æ¸¦å·»ã„ã¦ã„ã‚‹ã€‚"],
            ["å·¨å²©ã®ç›¾ãŒã€æ¸¯ã®æ³¢æ¿¤ã‚’é®ã‚ã‚‹ã€‚", "è¦å¡ã®é¨å£«ãŸã¡ãŒæµ·è³Šã‚’è¿½ã„æ‰•ã„ã€äº¤æ˜“è·¯ãŒé–‹ã‹ã‚ŒãŸã€‚", "æ¸¯ç”ºã¯ã‹ã¤ã¦ãªã„è³‘ã‚ã„ã‚’è¦‹ã›ã¦ã„ã‚‹ã€‚"],
            ["ä¿®é“é™¢ã®ç¥ˆã‚ŠãŒã€å¤ªå¤ã®é­‚ã‚’æ…°ã‚ã‚‹ã€‚", "è–å¥³ã®æµ„åŒ–ã«ã‚ˆã‚Šã€å¢“åœ°ã¯å®‰ã‚‰ãã®åœ°ã¸ã¨å¤‰ã‚ã£ãŸã€‚", "ä»Šå®µã€æ­»è€…ã‚’å²ã¶é™ã‹ãªç¥­ã‚ŠãŒå§‹ã¾ã‚‹ã€‚"],
            ["å¤åŸã®é—‡ãŒã€é—˜æŠ€å ´ã®é®®è¡€ã‚’æ±‚ã‚ã‚‹ã€‚", "å¸è¡€é¬¼ã®æˆ¯ã‚Œã§ã€å¤œãªå¤œãªéæ¿€ãªæ®ºã—åˆã„ãŒè¡Œã‚ã‚Œã‚‹ã€‚", "è¦³å®¢ã®ç†±ç‹‚ã¯ã€ææ€–ã¨å…±ã«æœ€é«˜æ½®ã¸é”ã™ã‚‹ã€‚"],
            ["è’é‡ã®æƒ…ç†±ãŒã€éš ã‚Œé‡Œã®æ‰‰ã‚’é–‹ãã€‚", "è¸Šã‚Šå­ãŸã¡ã®æƒ…ç†±ãŒã€é–‰ã–ã•ã‚ŒãŸã‚¨ãƒ«ãƒ•ã®å¿ƒã‚’æº¶ã‹ã™ã€‚", "æ£®ã®å¥¥æ·±ãã§ã€ç¨®æ—ã‚’è¶…ãˆãŸå®´ãŒå§‹ã¾ã‚‹ã€‚"],
            ["è¿·å®®ã®æ¢æ±‚è€…ãŒã€å¿˜ã‚Œã‚‰ã‚ŒãŸåŸã«æŒ‘ã‚€ã€‚", "äº¡éœŠã®å‘¼ã³å£°ã«å¿œãˆã€å»ƒå¢Ÿã«å¹»ã®ç¯ã‚ŠãŒã¨ã‚‚ã‚‹ã€‚", "ã‹ã¤ã¦ã®æ „è¯ãŒã€ä¸€å¤œã®å¤¢ã¨ã—ã¦è˜‡ã‚‹ã€‚"],
            ["é—˜æŠ€å ´ã®ç‹‚é¨’ãŒã€è¦å¡ã®é™å¯‚ã‚’ç ´ã‚‹ã€‚", "çŒ›è€…ãŸã¡ãŒå®ˆå‚™éšŠã«åŠ ã‚ã‚Šã€é‰„å£ã®å®ˆã‚ŠãŒç¯‰ã‹ã‚ŒãŸã€‚", "ã—ã‹ã—ã€ãã®è’ã€…ã—ã•ã«ä½æ°‘ã¯æ€¯ãˆã¦ã„ã‚‹ã€‚"],
            ["æ·±ç·‘ã®æ¯å¹ãŒã€è’é‡ã«æ½¤ã„ã‚’ã‚‚ãŸã‚‰ã™ã€‚", "ã‚¨ãƒ«ãƒ•ã®ç§˜è¡“ã«ã‚ˆã‚Šã€ç ‚æ¼ ã®åªä¸­ã«æ³‰ãŒæ¹§ãå‡ºã—ãŸã€‚", "ä¸æ¯›ã®å¤§åœ°ã«ã€å¥‡è·¡ã®èŠ±ãŒå’²ãä¹±ã‚Œã‚‹ã€‚"]
        ];

        const defaultRegionStats = [ { sec: 4, eco: 4 }, { sec: 5, eco: 2 }, { sec: 3, eco: 2 }, { sec: 1, eco: 1 }, { sec: 2, eco: 5 }, { sec: 2, eco: 4 }, { sec: 4, eco: 2 }, { sec: 1, eco: 2 }, { sec: 1, eco: 1 }, { sec: 3, eco: 1 }, { sec: 3, eco: 3 }, { sec: 1, eco: 3 } ];
        let stats = { health: 0, body: 0, mind: 0, magic: 0, fame: 0, money: 0 };
        let turn = 1, maxTurn = 20, isEventActive = false, isGameStarted = false, isTyping = false, targetText = "";
        let messageQueue = [], currentMsgIndex = 0, pendingResultHtml = "", typeInterval;
        let consecutiveNormalEvents = 0, lastEventWasHeroine = false, isForcedHeroine = false, isResultDisplayed = false;
        let currentGameLog = [];
        let unlockedBoosts = { health: false, body: false, mind: false, magic: false, fame: false, money: false };
        let activeBoosts = { health: false, body: false, mind: false, magic: false, fame: false, money: false };
        let activeImpacts = Array(12).fill(false);
        const gameAssets = { events: {}, heroines: {} };

        window.onload = async () => {
            const statusEl = document.getElementById("load-status"); const barFill = document.getElementById("load-bar-fill");
            const assetsToLoad = []; 
            
            // ä¿®æ­£ï¼š36ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ12ã‚¨ãƒªã‚¢Ã—3ãƒ©ãƒ³ã‚¯ï¼‰ã®ä¸€æ‹¬ãƒ­ãƒ¼ãƒ‰
            scenarios.forEach(s => {
                for (let i = 1; i <= 3; i++) {
                    assetsToLoad.push({ type: 'event', file: `${s.file}_${i}` });
                }
            });
            heroines.forEach(h => assetsToLoad.push({ type: 'heroine', file: h.file }));
            
            let loadedCount = 0;
            const loadPromises = assetsToLoad.map(async (asset) => {
                try {
                    const res = await fetch(`data/${asset.type === 'event' ? 'events' : 'heroines'}/${asset.file}.json`);
                    const data = await res.json();
                    if (asset.type === 'event') { 
                        gameAssets.events[asset.file] = data; // ä¾‹: gameAssets.events["e01_royal_city_1"] ã«æ ¼ç´
                    }
                    else if (asset.type === 'heroine') { gameAssets.heroines[asset.file] = await fetch(`data/heroines/${asset.file}.json`).then(r => r.json()); }
                    loadedCount++; const percent = (loadedCount / assetsToLoad.length) * 100; barFill.style.width = percent + "%"; statusEl.innerText = `Loading: ${asset.file} (${Math.round(percent)}%)`;
                } catch (e) { console.error(e); }
            });
            await Promise.all(loadPromises);
            
            try {
                const monoRes = await fetch('data/events/monologues.json');
                const monoJson = await monoRes.json();
                monologueData = monoJson.common;
                heroineReactions = monoJson.heroines;
                const specRes = await fetch('data/events/special.json');
                specialData = await specRes.json();
            } catch (e) { console.error("Data load failed", e); }

            heroineImpacts = heroines.map(h => {
                const conf = impactConfig[h.name];
                if (!conf) return { target: 0, sec: 0, eco: 0, name: "Unknown", btnLabel: "???" };
                const targetIdx = scenarios.findIndex(s => s.name === conf.targetName);
                return { 
                    target: targetIdx !== -1 ? targetIdx : 0, 
                    sec: conf.sec, eco: conf.eco, name: conf.name,
                    btnLabel: `${conf.targetName} +`
                };
            });

            const savedB = localStorage.getItem('maghribal_boosts'); if(savedB) unlockedBoosts = JSON.parse(savedB);
            const savedA = localStorage.getItem('maghribal_active_boosts'); if(savedA) activeBoosts = JSON.parse(savedA);
            const savedI = localStorage.getItem('maghribal_active_impacts'); if(savedI) activeImpacts = JSON.parse(savedI);
            const savedC = localStorage.getItem('maghribal_cleared_heroines'); if(savedC) clearedHeroines = JSON.parse(savedC);
            
            initUI(); displayPastRecords(); renderBoostButtons();
            resizeGameContainer(); window.addEventListener('resize', resizeGameContainer);
            
            checkResumeData(); 
            
            // â–¼â–¼â–¼ ä¿®æ­£: ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆå‡¦ç†ã«å¤‰æ›´ â–¼â–¼â–¼
            setTimeout(() => { 
                const loader = document.getElementById("loading-screen");
                loader.classList.add("loaded"); // é€æ˜åŒ–é–‹å§‹
                
                // CSSã®transition(0.5s)ãŒçµ‚ã‚ã£ãŸé ƒã«å®Œå…¨ã«æ¶ˆã™
                setTimeout(() => {
                    loader.style.display = "none";
                }, 500);
            }, 800);
        };
        
        function checkResumeData() {
            try {
                const savedSession = localStorage.getItem('maghribal_resume_data');
                if(savedSession) {
                    const btn = document.getElementById('continue-btn');
                    if(btn) {
                        btn.style.display = 'block'; 
                    }
                }
            } catch(e) { console.error("Error checking resume data:", e); }
        }

        function saveSessionData() {
            if (turn > maxTurn && activeImpacts.findIndex(Boolean) === -1) return; 
            try {
                const sessionData = {
                    turn: turn,
                    stats: stats,
                    activeImpacts: activeImpacts,
                    consecutiveNormalEvents: consecutiveNormalEvents,
                    lastEventWasHeroine: lastEventWasHeroine,
                    heroineProgress: heroines.map(h => ({p: h.progress || 0, a: h.affection || 0})),
                    gameLog: currentGameLog
                };
                localStorage.setItem('maghribal_resume_data', JSON.stringify(sessionData));
                
                const contBtn = document.getElementById("continue-btn");
                if(contBtn) contBtn.style.display = "block";
            } catch(e) {
                console.error("Save failed:", e);
            }
        }

        function continueGame() {
            playSE(seOp); // â˜…è¿½åŠ ï¼šGAME STARTã¨åŒã˜éŸ³ã‚’é³´ã‚‰ã™
            const saved = localStorage.getItem('maghribal_resume_data');
            if (!saved) return;
            try {
                const data = JSON.parse(saved);

                turn = data.turn;
                stats = data.stats;
                activeImpacts = data.activeImpacts || Array(12).fill(false);
                consecutiveNormalEvents = data.consecutiveNormalEvents;
                lastEventWasHeroine = data.lastEventWasHeroine;
                currentGameLog = data.gameLog || [];

                if (data.heroineProgress) {
                    heroines.forEach((h, i) => {
                        if (data.heroineProgress[i]) {
                            h.progress = data.heroineProgress[i].p;
                            h.affection = data.heroineProgress[i].a;
                        }
                    });
                }

                document.getElementById("title-screen").classList.add("hidden-screen");
                document.getElementById("top-ui-container").style.display = "flex";
                document.getElementById("background-layer").classList.add("visible");
                document.querySelectorAll('.map-spot').forEach(s => s.classList.add('spot-visible'));

                statKeys.forEach(k => updateUI(k));
                document.getElementById("turn-count").innerText = turn;
                document.getElementById("log-content").innerHTML = currentGameLog.join('');
                updateMapState();

                bgmOp.pause();
                bgmMap.currentTime = 0;
                bgmMap.play();
                isGameStarted = true;
                
                updateMonologue('resume', false); 
            } catch(e) {
                console.error("Load failed:", e);
                alert("ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
            }
        }
        
        const updateMonologue = (type = 'random', saveToLog = true) => { 
            const container = document.getElementById('monologue-container');
            const textEl = container.querySelector('.monologue-text');
            
            if (activeImpacts.findIndex(Boolean) !== -1) { container.style.display = 'none'; return; }

            let text = "";
            let pool = [];

            if (type === 'resume') { 
                text = "â€¦â€¦ã•ã¦ã€æ—…ã®ç¶šãã‚’å§‹ã‚ã‚ˆã†ã€‚"; 
            } else if (type === 'start') {
                pool = monologueData.start;
            } else if (lastEventContext) { 
                const { name, progress } = lastEventContext;
                const stage = Math.min(progress - 1, 5); 
                if (heroineReactions[name] && heroineReactions[name][stage]) {
                    text = heroineReactions[name][stage];
                } else {
                    pool = monologueData.success; 
                }
                lastEventContext = null;
            } else {
                const maxStats = statKeys.filter(k => stats[k] >= 50);
                if (maxStats.length > 0 && Math.random() < 0.3) { 
                    pool = monologueData.stat_max; 
                } 
                else if (lastEventResult && Math.random() < 0.7) {
                    const resKey = (lastEventResult === 'great_success' || lastEventResult === 'great') ? 'great' : lastEventResult;
                    pool = monologueData[resKey] || monologueData.failure;
                    lastEventResult = null;
                }
                else if (Math.random() < 0.4) { 
                    const unmetHeroines = heroines.filter(h => h.progress === 0);
                    if (unmetHeroines.length > 0 && Math.random() < 0.5) {
                        const target = unmetHeroines[Math.floor(Math.random() * unmetHeroines.length)];
                        const originalIdx = heroines.indexOf(target);
                        if (originalIdx !== -1) {
                            text = `å™‚ã«ã‚ˆã‚‹ã¨ã€${scenarios[originalIdx].name}ã®æ–¹ã«${target.title}ãŒã„ã‚‹ã‚‰ã—ã„ã€‚`;
                        }
                    } else {
                        pool = monologueData.hint_weak;
                    }
                }
                else {
                    if (turn < 5) pool = monologueData.progress_low;
                    else if (turn < 15) pool = monologueData.progress_mid;
                    else pool = monologueData.progress_high;
                }
            }

            if (!text) {
                if (!pool || pool.length === 0) pool = monologueData.progress_mid;
                text = pool[Math.floor(Math.random() * pool.length)];
            }

            if (saveToLog) {
                currentGameLog.push(`<div class=\"log-entry monologue-log\">ï¼ˆç‹¬ã‚Šè¨€ï¼‰${text}</div>`);
                const logContent = document.getElementById("log-content");
                if (logContent) {
                    logContent.innerHTML = currentGameLog.join('');
                }
            }

            textEl.innerHTML = "";
            container.style.display = 'flex';
            container.classList.remove('visible');
            void container.offsetWidth; 
            container.classList.add('visible');
            
            clearInterval(monologueInterval);
            let i = 0;
            monologueInterval = setInterval(() => {
                textEl.textContent += text.charAt(i);
                i++;
                if (i >= text.length) clearInterval(monologueInterval);
            }, 50);
        };
        
function handleSpotClick(el, idx) {
            document.getElementById('monologue-container').classList.remove('visible');

            const activeIdx = activeImpacts.findIndex(Boolean);
            if (activeIdx !== -1 && idx !== heroineImpacts[activeIdx].target) return;

            if (!isGameStarted || isEventActive || (activeIdx === -1 && turn > maxTurn)) return; 
            isEventActive = true; isResultDisplayed = false; isResultHidden = false;
            playSE(seFootstep); 
            
            let stopBgm = false;

            el.querySelector('.hint-text').classList.add('selected-yellow'); 
            document.querySelectorAll('.map-spot').forEach(s => s.classList.remove('spot-visible'));
            
            const s = scenarios[idx];
            const h = heroines[idx]; 
            h.events = gameAssets.heroines[h.file].events; 
            
            const avgStat = Object.values(stats).reduce((a, b) => a + b, 0) / 6;
            const assign = spotAssignments[idx];
            const anyM = heroines.some(hero => hero.progress >= 5);
            
            const minVal = Math.min(...Object.values(stats)); 
            const weakStats = statKeys.filter(k => stats[k] === minVal); 
            const isRecommended = weakStats.includes(assign.main) || weakStats.includes(assign.sub);
            
            let tierNum, tierKey; 
            const progressRatio = turn / maxTurn;
            if (progressRatio <= 1/6) { tierNum = 1; tierKey = 'newcomer'; }
            else if (progressRatio <= 5/6) { tierNum = 2; tierKey = 'mid'; }
            else { tierNum = 3; tierKey = 'veteran'; }
            
            const eventFile = gameAssets.events[`${s.file}_${tierNum}`];

            let isH = false, dMsg = "", bCh = {}, out = 'success';

            if (activeIdx !== -1) {
                isH = false; isResultHidden = true; stopBgm = true;
                if (specialData[activeIdx]) {
                    dMsg = specialData[activeIdx].text;
                    bCh = specialData[activeIdx].changes;
                } else {
                    dMsg = "ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚";
                    bCh = {};
                }
                out = 'exclusive'; 
            } else {
                let chance = isForcedHeroine ? 1.0 : (stats[assign.main] / 50) + (consecutiveNormalEvents * 0.1); 
                if (chance < 0.05) chance = 0.05; 
                if (lastEventWasHeroine && !isForcedHeroine) chance = 0;
                
                if (h.progress >= 5) { 
                    isH = true; lastEventWasHeroine = true; isResultHidden = true; stopBgm = true;
                    dMsg = "ã€å¾Œæ—¥è«‡ã€‘\n" + (h.afterMsg || "ç©ã‚„ã‹ãªæ™‚é–“ãŒæµã‚ŒãŸã€‚"); 
                    bCh[assign.main] = 5; bCh[assign.sub] = 2; 
                    out = 'heroine'; 
                    lastEventContext = { name: h.name, progress: 6 }; 
                    if (!clearedHeroines.includes(h.name)) {
                        clearedHeroines.push(h.name);
                        localStorage.setItem('maghribal_cleared_heroines', JSON.stringify(clearedHeroines));
                    }
                } 
                else if (anyM && h.progress >= 1) { 
                    isH = true; lastEventWasHeroine = true; stopBgm = true;
                    dMsg = "ã€ä¸–é–“è©±ã€‘\n" + (h.chatMsg || "ä½•æ°—ãªã„ä¸–é–“è©±ã‚’ã—ã¦åˆ¥ã‚ŒãŸã€‚"); 
                    bCh[assign.main] = 2; bCh[assign.sub] = 1; 
                    out = 'heroine'; 
                } 
                else if (Math.random() < chance) { 
                    const reqA = h.minAvg[Math.min(h.progress, 4)] || 0;
                    const reqS = (h.progress + 1) * 8;
                    const mIdx = h.progress < 2 ? 0 : 1; 
                    
                    if (avgStat < reqA) { 
                        isH = false; lastEventWasHeroine = false; 
                        dMsg = h.lockAvgMsgs[mIdx]; 
                        bCh[assign.main] = 1; bCh[assign.sub] = 1; 
                        out = 'hint'; 
                    } 
                    else if (stats[assign.main] < reqS) { 
                        isH = false; lastEventWasHeroine = false; 
                        dMsg = h.lockStatMsgs[mIdx]; 
                        bCh[assign.main] = 1; bCh[assign.sub] = 1; 
                        out = 'hint'; 
                    } 
                    else { 
                        isH = true; lastEventWasHeroine = true; consecutiveNormalEvents = 0; stopBgm = true;
                        dMsg = h.events[Math.min(h.progress, 4)]; 
                        h.progress++; h.affection++; 
                        if (h.progress >= 3) isResultHidden = true; 
                        bCh[assign.main] = 5; bCh[assign.sub] = 2; 
                        out = 'heroine'; 
                        lastEventContext = { name: h.name, progress: h.progress };
                        if (h.progress >= 5) {
                            if (!clearedHeroines.includes(h.name)) {
                                clearedHeroines.push(h.name);
                                localStorage.setItem('maghribal_cleared_heroines', JSON.stringify(clearedHeroines));
                            }
                        }
                    } 
                } 
                else { 
                    // é€šå¸¸ã‚¤ãƒ™ãƒ³ãƒˆã®æŠ½é¸
                    isH = false; lastEventWasHeroine = false; consecutiveNormalEvents++; 
                    
                    let pool = [];
                    // ãƒ‡ãƒ¼ã‚¿å½¢å¼ï¼ˆé…åˆ—orã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼‰ã®è‡ªå‹•åˆ¤åˆ¥ã¯ç¶­æŒ
                    if (Array.isArray(eventFile)) {
                        pool = eventFile;
                    } else if (eventFile && typeof eventFile === 'object') {
                        const tierData = eventFile[tierKey] || Object.values(eventFile)[0];
                        if (Array.isArray(tierData)) {
                            pool = tierData; 
                        } else if (tierData) {
                            pool = [].concat(tierData.success || [], tierData.failure || [], tierData.great || []);
                        }
                    }
                    
                    let targetPool = pool;
                    if (isRecommended) { 
                        const successPool = pool.filter(e => e.outcome !== 'failure'); 
                        if (successPool.length > 0) targetPool = successPool; 
                    } 
                    
                    // ã€ä¿®æ­£ã€‘ã€Œé™ã‹ãªæ™‚ãŒæµã‚ŒãŸã€ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å‰Šé™¤
                    const ev = targetPool[Math.floor(Math.random() * targetPool.length)];
                    
                    // evãŒå–å¾—ã§ããŸå ´åˆã®ã¿å‡¦ç†ã‚’å®Ÿè¡Œï¼ˆãªã‘ã‚Œã°ã‚¨ãƒ©ãƒ¼ç­‰ã§æ­¢ã¾ã‚‹ï¼‰
                    if (ev) {
                        dMsg = ev.text; 
                        bCh = {...(ev.changes || {})}; 
                        out = ev.outcome; 
                        lastEventResult = out;
                        
                        // ã€ç¢ºèªç”¨ãƒ­ã‚°ã€‘æ­£ã—ã„ãƒ†ã‚­ã‚¹ãƒˆãŒå¼•ã‘ã¦ã„ã‚‹ã‹ç¢ºèªç”¨
                        console.log(`[EventCheck] File:${s.file}_${tierNum}, Key:${tierKey}, Text:${dMsg}`);
                    } else {
                        console.error(`[EventError] No event found for ${s.file}_${tierNum} (${tierKey})`);
                    }
                }
                
                if (isRecommended) { 
                    for (let k in bCh) { if (bCh[k] > 0) bCh[k] += 1; } 
                }
            }
            
            if (stopBgm) bgmMap.pause();
            
            // evãŒå–å¾—ã§ããšdMsgãŒç©ºã®å ´åˆã€ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦è¡¨ç¤ºã§ãŠã‹ã—ããªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ãŒã€
            // ã€Œãƒ­ã‚¸ãƒƒã‚¯ã‚’å…¥ã‚Œãªã„ã€æ–¹é‡ã«å¾“ã„ãã®ã¾ã¾æ¸¡ã—ã¾ã™ã€‚
            applyEventView(dMsg, bCh, isH, h, s, out, idx);
        }
        function applyEventView(msg, changes, isH, h, s, out, idx) {
            for (let k in changes) { stats[k] = Math.max(0, Math.min(stats[k] + (changes[k] || 0), 50)); updateUI(k); } checkRankUpdate(); 
            let cLog = isResultHidden ? "" : getResultHtml(changes); 
            let outcomeHtml = ""; 
            if (!isH && out !== 'hint' && out !== 'heroine' && out !== 'exclusive') { 
                if (out === 'great_success' || out === 'great') outcomeHtml = `<span class=\"outcome-badge great\">ã€å¤§æˆåŠŸã€‘</span>`; 
                else if (out === 'success') outcomeHtml = `<span class=\"outcome-badge success\">ã€æˆåŠŸã€‘</span>`; 
                else if (out === 'failure') outcomeHtml = `<span class=\"outcome-badge failure\">ã€å¤±æ•—ã€‘</span>`; 
            } 
            let logL = isH ? `(<i class=\"fa-solid ${h ? h.icon : ''}\"></i> ${h ? h.name : ''})` : ""; const locLabel = `<i class=\"fa-solid ${s.icon}\"></i> ${s.name}`; currentGameLog.push(`<div class=\"log-entry\"><div class=\"log-header\">Turn ${turn} : ${locLabel} ${logL} ${outcomeHtml} ${getResultHtml(changes)}</div><div class=\"log-body\">${formatGameText(msg).replace(/\n/g, '<br>')}</div></div>`); document.getElementById("log-content").innerHTML = currentGameLog.join(''); document.getElementById("background-layer").style.transformOrigin = `${spotAssignments[idx].l}% ${spotAssignments[idx].t}%`; document.getElementById("background-layer").style.transform = `scale(${s.zoom || 2.5})`; document.getElementById("background-layer").classList.add("blur-bg"); 
            
            if (typeof msg === 'string') {
                messageQueue = msg.split('\n').filter(line => line.trim() !== "");
            } else {
                messageQueue = Array.isArray(msg) ? msg : [msg];
            }
            
            currentMsgIndex = 0; isResultDisplayed = false; pendingResultHtml = outcomeHtml + cLog; document.getElementById("loc-icon").innerHTML = `<i class=\"fa-solid ${s.icon}\"></i>`; document.getElementById("loc-name").innerText = s.name; document.getElementById("loc-stats").innerHTML = getLocStatusHtml(idx); const cb = document.getElementById("char-name-badge"); if (isH && h) { cb.innerHTML = `<i class=\"fa-solid ${h.icon}\"></i> ${h.title} ${h.name}`; cb.style.display = "flex"; } else cb.style.display = "none"; document.getElementById("message-text").innerHTML = ""; document.getElementById("result-display").innerHTML = ""; document.getElementById("result-display").style.opacity = "0"; document.getElementById("page-cursor").classList.remove("active"); document.getElementById("message-window").classList.add("active"); document.getElementById("click-overlay").classList.add("active"); setTimeout(advanceMessage, 300);
        }
        function advanceMessage() { 
            const cursor = document.getElementById("page-cursor"); 
            if (isTyping) { finishTyping(); return; } 
            if (currentMsgIndex < messageQueue.length) { 
                cursor.classList.remove("active"); targetText = messageQueue[currentMsgIndex++]; typeWriter(document.getElementById("message-text"), targetText, 15); 
            } else {
                if (isResultHidden) { closeEvent(); } else if (!isResultDisplayed) { cursor.classList.remove("active"); showFinalResult(); cursor.classList.add("active"); } else { cursor.classList.remove("active"); closeEvent(); }
            }
        }
        function getResultHtml(changes) { let h = ''; for (let k in changes) { if (changes[k] !== 0) { const arrow = changes[k] > 0 ? `<span style=\"color:#76ff03; font-size:0.8em;\">â–²</span>` : `<span style=\"color:#ea80fc; font-size:0.8em;\">â–¼</span>`; h += `<span style=\"color:${statColors[k]}; margin:0 8px; font-weight:bold; white-space:nowrap;\"><i class=\"fa-solid ${statConfig[k].icon}\"></i> ${statConfig[k].name}${arrow}</span>`; } } return h; }
        
        function closeEvent() { 
            document.getElementById("background-layer").style.transform = "scale(1)"; document.getElementById("background-layer").classList.remove("blur-bg"); document.getElementById("message-window").classList.remove("active"); document.getElementById("click-overlay").classList.remove("active"); document.getElementById("page-cursor").classList.remove("active"); 
            if (bgmMap.paused && activeImpacts.findIndex(Boolean) === -1) bgmMap.play();

            const activeIdx = activeImpacts.findIndex(Boolean);
            if (activeIdx !== -1) { 
                document.getElementById('fade-overlay').classList.add('active'); bgmMap.pause(); setTimeout(showEnding, 1500); 
                return; 
            }
            
            if (turn < maxTurn) { 
                turn++; 
                document.getElementById("turn-count").innerText = turn; 
                isEventActive = false; 
                updateMonologue(); 
                saveSessionData(); 
                
                setTimeout(() => { 
                     document.querySelectorAll('.map-spot').forEach(s => { s.classList.add('spot-visible'); s.querySelector('.hint-text').classList.remove('selected-yellow'); }); 
                }, 250);
            } 
            else { 
                updateMonologue(); 
                saveSessionData(); 
                setTimeout(() => { document.getElementById('fade-overlay').classList.add('active'); bgmMap.pause(); setTimeout(showEnding, 3000); }, 3000);
            }
        }
        function showEnding() { 
            processBoostUnlock(); 
            if (activeImpacts.findIndex(Boolean) === -1) saveCurrentGameLog();
            
            localStorage.removeItem('maghribal_resume_data'); 

            document.getElementById("ed-screen").classList.remove("hidden-screen"); 
            bgmMap.pause(); bgmEd.currentTime = 0; bgmEd.play();
            
            const activeIdx = activeImpacts.findIndex(Boolean);
            if (activeIdx !== -1) {
                document.getElementById("ed-rank").innerText = "SPECIAL EPISODE CLEAR";
                const h1 = heroines[activeIdx];
                const tIdx = heroineImpacts[activeIdx].target;
                const scene = scenarios[tIdx];
                const h2 = heroines.find(h => h.file === scene.file) || heroines[tIdx];
                const partnerHTML = `<span style=\"display:flex; align-items:center; gap:8px;\"><i class=\"fa-solid ${h1.icon}\"></i> ${h1.name} <span style=\"font-size:0.8em; opacity:0.7;\">+</span> <i class=\"fa-solid ${scene.icon}\"></i> ${scene.name} <span style=\"font-size:0.8em; opacity:0.7;\">+</span> <i class=\"fa-solid ${h2.icon}\"></i> ${h2.name}</span>`;
                document.getElementById("ed-heroine").innerHTML = partnerHTML;
                document.getElementById("ed-stats").innerHTML = ""; 
            } else {
                const total = Object.values(stats).reduce((sum, v) => sum + v, 0); let rank = total >= 150 ? "LEGEND" : (total >= 100 ? "GOLD" : (total >= 50 ? "SILVER" : "BRONZE")); document.getElementById("ed-rank").innerText = `Rank: ${rank}`; let best = heroines.reduce((a, b) => a.affection > b.affection ? a : b); let endingDisplay = ""; if (best && best.affection > 0) { const hIcon = `<i class=\"fa-solid ${best.icon}\" style=\"margin:0 10px;\"></i>`; let affinityIcon = ""; if (best.progress >= 5) affinityIcon = `<span class=\"affinity-icon bouquet-icon\"><i class=\"fa-solid fa-mound\"></i></span>`; else if (best.progress >= 3) affinityIcon = `<span class=\"affinity-icon affinity-seedling\" style=\"margin-left:8px;\"><i class=\"fa-solid fa-seedling\"></i></span>`; else affinityIcon = `<span class=\"affinity-icon affinity-leaf\" style=\"margin-left:8px;\"><i class=\"fa-solid fa-leaf\"></i></span>`; endingDisplay = `Partner: ${hIcon} ${best.name}${affinityIcon}`; } else { const maxK = [...statKeys].sort((a, b) => stats[b] - stats[a])[0]; endingDisplay = `ç§°å·: ${soloTitles[maxK]}`; } document.getElementById("ed-heroine").innerHTML = endingDisplay; let h = ""; statKeys.forEach(k => { const val = Math.floor(stats[k]); const isMax = val >= 50; const color = statColors[k]; const borderStyle = isMax ? `border: 2px solid ${color}; box-shadow: 0 0 10px ${color};` : ""; const iconStyle = isMax ? `color: ${color};` : ""; const maxLabel = isMax ? `<span class=\"max-label\" style=\"color:${color}\">MAX</span>` : ""; h += `<div class=\"ed-stat-box\" style=\"${borderStyle}\"><i class=\"fa-solid ${statConfig[k].icon}\" style=\"${iconStyle}\"></i><div style=\"font-size:9px; color:#ccc;\">${statConfig[k].name}</div><span class=\"ed-stat-val\">${val}</span>${maxLabel}</div>`; }); document.getElementById("ed-stats").innerHTML = h; 
            }
            setTimeout(() => { document.getElementById('fade-overlay').classList.remove('active'); }, 500);
        }
        function startOP() { 
            seOp.currentTime = 0; seOp.play(); 
            resizeGameContainer(); currentGameLog = []; document.getElementById("log-content").innerHTML = ""; 
            const activeIdx = activeImpacts.findIndex(Boolean);
            if (activeIdx !== -1) { statKeys.forEach(k => { stats[k] = 0; updateUI(k); }); } else { statKeys.forEach(k => { stats[k] = activeBoosts[k] ? 10 : 0; updateUI(k); }); }
            bgmOp.pause(); bgmOp.currentTime = 0; bgmOp.play(); 
            document.getElementById("title-screen").classList.add("hidden-screen"); 
            setTimeout(() => { document.getElementById("op-screen").classList.remove("hidden-screen"); 
            const opLines = (activeIdx !== -1) ? heroineOPLines[activeIdx] : ["é™½ãŒæ²ˆã‚€è¥¿ã®åœ°ã€ãƒã‚°ãƒªãƒãƒ«ã€‚", "ã“ã“ã«ã¯åå£°ã€å¯Œã€çŸ¥è­˜ã€ãã—ã¦åŠ›ãŒçœ ã£ã¦ã„ã‚‹ã€‚", "æ®‹ã•ã‚ŒãŸæ™‚é–“ã¯ã€ãã†é•·ãã¯ãªã„ã€‚", "ã©ã®é“ã‚’æ­©ã¿ã€ä½•è€…ã¨ãªã‚‹ã‹ã€‚", "å…¨ã¦ã¯æ±ã®é¸æŠã«å§”ã­ã‚‰ã‚Œã¦ã„ã‚‹ã€‚"];
            updateMapState(); 
            
            let idx = 0; const opDiv = document.getElementById("op-text"); const showLine = () => { opDiv.style.opacity = 0; setTimeout(() => { opDiv.innerHTML = opLines[idx]; opDiv.style.opacity = 1; }, 400); }; showLine(); window.nextOP = () => { idx++; if (idx < opLines.length) showLine(); else { 
                document.getElementById("op-screen").classList.add("hidden-screen"); document.getElementById("top-ui-container").style.display = "flex"; document.getElementById("background-layer").classList.add("visible"); 
                bgmOp.pause(); bgmMap.currentTime = 0; bgmMap.play();
                setTimeout(() => { 
                    document.querySelectorAll('.map-spot').forEach(s => s.classList.add('spot-visible')); 
                    updateMonologue('start');
                    isGameStarted = true; 
                }, 1000); 
            } }; }, 500); 
        }
        // RETRYãƒœã‚¿ãƒ³ç”¨ã®é–¢æ•°ï¼ˆæš—è»¢è¿½åŠ ç‰ˆï¼‰
        function retryGame() {
            playSE(seFootstep); // è¶³éŸ³å†ç”Ÿ
            
            // æš—è»¢å‡¦ç†ã‚’é–‹å§‹ (CSSã®transition: 1.5sã«åˆã‚ã›ã¦ã„ã¾ã™)
            document.getElementById('fade-overlay').classList.add('active'); 
            
            // æš—è»¢ã—ãã£ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°(1.5ç§’å¾Œ)ã§ãƒªãƒ­ãƒ¼ãƒ‰
            setTimeout(() => {
                location.reload();
            }, 1500);
        }
        function processBoostUnlock() { const sortedKeys = [...statKeys].sort((a, b) => stats[b] - stats[a]); for (let key of sortedKeys) { if (!unlockedBoosts[key]) { unlockedBoosts[key] = true; localStorage.setItem('maghribal_boosts', JSON.stringify(unlockedBoosts)); break; } } }
        
    </script>
</body>
</html>
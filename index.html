<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Days in Maghribal - Polish Ver</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- CSS: スタイル定義 --- */
        body { 
            margin: 0; padding: 0; background: #000; 
            display: flex; justify-content: center; align-items: center; height: 100vh;
            font-family: "Yu Mincho", "MS 明朝", serif; overflow: hidden; user-select: none;
        }
        #game-container {
            position: relative; width: 1280px; height: 720px;
            background: #050505; border: 1px solid #333; overflow: hidden;
        }
        :root { --theme-color: #b08d55; --theme-glow: #5e4b25; --bg-tint: rgba(40, 30, 20, 0.9); }
        .rank-silver { --theme-color: #aaccff; --theme-glow: #446688; --bg-tint: rgba(20, 25, 35, 0.9); }
        .rank-gold { --theme-color: #e5cfa0; --theme-glow: #887040; --bg-tint: rgba(45, 40, 20, 0.9); }
        .rank-legend { --theme-color: #ffffff; --theme-glow: #e0e0ff; --bg-tint: rgba(30, 30, 35, 0.95); }

        #background-layer {
            position: absolute; width: 100%; height: 100%;
            background-image: url('images/all_map.PNG'); 
            background-size: 100% 100%; background-position: center; background-repeat: no-repeat;
            opacity: 0; 
            transition: transform 0.8s cubic-bezier(0.25, 1, 0.5, 1), opacity 1.5s ease, filter 0.4s ease;
            will-change: transform, opacity, filter; z-index: 1;
        }
        #background-layer.visible { opacity: 1; }
        #background-layer.blur-bg { filter: blur(5px) brightness(0.7); }

        .map-spot {
            position: absolute; width: 150px; height: 150px;
            cursor: pointer; z-index: 50;
            display: flex; justify-content: center; align-items: center;
            /* ★演出時に残らないよう、transitionを0.2sに短縮 */
            transition: opacity 0.2s ease; transform: translate(-50%, -50%);
            opacity: 0; pointer-events: none; 
        }
        .map-spot.spot-visible { opacity: 1; pointer-events: auto; }
        .spot-core { width: 16px; height: 16px; background: #fff; border-radius: 50%; box-shadow: 0 0 20px #fff; z-index: 5; pointer-events: none; }
        
        .orb { position: absolute; border-radius: 50%; filter: blur(8px); pointer-events: none; }
        .orb-main { width: 45px; height: 45px; animation: rotateOrbCommon 5s infinite linear; opacity: 0.6; }
        .orb-sub { width: 32px; height: 32px; animation: rotateOrbCommon 5s infinite linear; animation-delay: -0.8s; opacity: 0.8; }

        @keyframes rotateOrbCommon { 
            from { transform: rotate(0deg) translateX(42px); } 
            to { transform: rotate(360deg) translateX(42px); } 
        }

        .hint-container { position: absolute; bottom: 20px; display: flex; justify-content: center; align-items: center; pointer-events: auto; width: 200px; height: 60px; }
        .hint-text { 
            font-size: 18px; color: #fff; font-weight: 900; letter-spacing: 1px; 
            text-shadow: 2px 2px 0 #000, -2px -2px 0 #000, 2px -2px 0 #000, -2px 2px 0 #000; 
            white-space: nowrap; transition: all 0.3s ease; position: relative; z-index: 10; 
            display: flex; align-items: center; gap: 8px; 
        }
        .map-spot:hover .hint-text { transform: scale(1.1); color: #ffffcc; }
        .hint-text.selected-yellow { color: #ffeb3b !important; text-shadow: 0 0 20px #ffaa00, 0 0 10px #fff; transform: scale(1.15); }

        #top-ui-container { position: absolute; top: 20px; right: 20px; z-index: 400; display: flex; gap: 10px; align-items: center; display: none; }
        #turn-display {
            font-family: 'Cinzel', serif; font-size: 18px; letter-spacing: 1px;
            color: var(--theme-color); text-shadow: 0 0 5px var(--theme-glow);
            background: rgba(5, 5, 5, 0.9); border: 1px solid var(--theme-color);
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            height: 46px; padding: 0 15px; display: flex; align-items: center; justify-content: center; box-sizing: border-box;
        }

        .ui-btn { 
            position: static; height: 46px; padding: 0 20px; 
            background: var(--bg-tint); color: #eee; border: 1px solid var(--theme-color); 
            cursor: pointer; transition: all 0.3s ease;
            font-family: 'Cinzel', serif; letter-spacing: 2px; box-sizing: border-box; display: block; 
        }
        .ui-btn:hover { background: rgba(120,100,80,0.5); }

        #stats-panel { 
            position: absolute; top: 75px; right: 20px; 
            background: var(--bg-tint); color: #fff; padding: 25px; 
            border: 1px solid var(--theme-color); z-index: 390; display: none; min-width: 260px; 
        }
        .stat-label { font-weight: bold; display: flex; align-items: center; gap: 8px; text-shadow: 1px 1px 2px #000; }
        .stat-bar-bg { width: 100%; height: 6px; background: #222; border-radius: 3px; margin-top: 6px; overflow: hidden; }
        .stat-bar-fill { height: 100%; width: 0%; transition: width 1s ease-out; }

        #log-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 1500; display: none;
            flex-direction: column; align-items: center; justify-content: center;
        }
        #log-window {
            width: 80%; height: 80%;
            background: rgba(20, 15, 10, 0.95); border: 2px solid var(--theme-color);
            padding: 30px; box-sizing: border-box;
            overflow-y: auto; color: #ccc;
            font-size: 16px; line-height: 1.8; text-align: left;
        }
        .log-header {
            color: var(--theme-color); font-weight: bold; margin-top: 20px; margin-bottom: 10px;
            border-bottom: 1px solid #444; padding-bottom: 5px;
            display: flex; justify-content: flex-start; align-items: center; gap: 10px;
        }
        .log-entry { margin-bottom: 8px; }

        #click-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 300; display: none; cursor: pointer; }
        #click-overlay.active { display: block; }

        #message-window { 
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 70%; 
            height: 90px; background: rgba(15, 12, 10, 0.95); color: #e0e0e0; 
            padding: 35px 40px 10px 40px; border: 1px solid #776655; 
            font-size: 18px; line-height: 1.6; z-index: 310; 
            box-shadow: 0 -5px 30px rgba(0,0,0,0.8);
            opacity: 0; transform: translateX(-50%) translateY(30px); pointer-events: none;
            transition: opacity 0.3s ease, transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            cursor: pointer;
        }
        #message-window.active { opacity: 1; transform: translateX(-50%) translateY(0); pointer-events: auto; }

        #location-badge {
            position: absolute; top: -35px; left: 0; height: 35px;
            background: var(--theme-color); color: #000;
            display: flex; align-items: center; gap: 15px; padding: 0 40px 0 20px;
            font-family: 'Cinzel', serif; font-weight: bold; clip-path: polygon(0 0, 100% 0, 90% 100%, 0% 100%);
        }
        #char-name-badge {
            position: absolute; top: -35px; right: 0; height: 35px;
            background: rgba(10, 10, 10, 0.95); border: 1px solid var(--theme-color); border-bottom: none;
            color: var(--theme-color); padding: 0 20px 0 40px;
            display: none; align-items: center; gap: 10px; clip-path: polygon(10% 0, 100% 0, 100% 100%, 0% 100%);
        }

        .overlay-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #fff; text-align: center; }
        .hidden-screen { opacity: 0; pointer-events: none; }
        
        #title-screen h1 { 
            font-family: 'Cinzel', serif; font-size: 60px; color: #b08d55; letter-spacing: 5px; 
            text-shadow: 0 0 20px #000, 0 0 10px #000, 2px 2px 5px #000;
            margin-bottom: 10px; z-index: 2; 
        }
        #title-screen h2 { 
            font-size: 28px; color: #887040; letter-spacing: 15px; margin-bottom: 60px; font-weight: normal; 
            text-shadow: 0 0 15px #000, 0 0 5px #000, 1px 1px 3px #000;
            z-index: 2; 
        }
        #start-btn, #retry-btn, #ed-log-btn { 
            padding: 15px 40px; font-size: 24px; color: #fff; background: rgba(0,0,0,0.5); 
            border: 1px solid #b08d55; cursor: pointer; letter-spacing: 5px; transition: 0.3s; 
            font-family: 'Cinzel', serif; z-index: 2; 
            text-shadow: 1px 1px 3px #000;
        }
        #start-btn:hover, #retry-btn:hover, #ed-log-btn:hover { background: #b08d55; color: #000; box-shadow: 0 0 20px #b08d55; }
        
        #title-img-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: url('images/title.png') no-repeat center center;
            background-size: cover; z-index: 1;
            filter: url(#water-filter) blur(1px) brightness(0.85); 
            animation: waterRipple 12s infinite alternate ease-in-out;
        }

        @keyframes waterRipple {
            0% { transform: scale(1.0); filter: url(#water-filter) blur(0px) brightness(0.85); }
            50% { transform: scale(1.03); filter: url(#water-filter) blur(2px) brightness(0.9); }
            100% { transform: scale(1.01); filter: url(#water-filter) blur(1px) brightness(0.8); }
        }

        #op-text { font-size: 28px; line-height: 2.5; max-width: 800px; opacity: 0; transition: opacity 1s; font-family: "Yu Mincho", serif; }
        #page-cursor { position: absolute; bottom: 10px; right: 20px; font-size: 20px; color: var(--theme-color); animation: cursorBlink 1s infinite alternate; display: none; }
        @keyframes cursorBlink { 0% { opacity: 0.3; } 100% { opacity: 1; } }

        #ed-rank { font-family: 'Cinzel', serif; font-size: 50px; margin-bottom: 20px; color: var(--theme-color); }
        #ed-msg { font-size: 24px; margin-bottom: 40px; line-height: 2; color: #ccc; max-width: 800px; }
        #ed-stats { display: flex; gap: 20px; margin-bottom: 40px; color: #aaa; }
        .ed-stat-box { border: 1px solid #444; padding: 10px 20px; text-align: center; }
        .ed-stat-val { display: block; font-size: 24px; color: #fff; margin-top: 5px; font-family: 'Cinzel', serif; }

        #debug-panel { 
            position: fixed; top: 10px; left: 10px; 
            background: rgba(0, 0, 0, 0.85); color: #0f0; padding: 12px; 
            border: 1px solid #0f0; font-family: monospace; font-size: 11px; 
            z-index: 9999; display: none; pointer-events: auto;
            border-radius: 4px; box-shadow: 0 0 10px #00ff00; width: 180px;
        }
        #debug-toggle { position: fixed; top: 0; left: 0; width: 20px; height: 20px; background: rgba(0,255,0,0.1); cursor: pointer; z-index: 10000; }
        .debug-btn { 
            background: #1a1a1a; color: #0f0; border: 1px solid #0f0; 
            padding: 4px 8px; cursor: pointer; margin-bottom: 6px; 
            display: block; width: 100%; text-align: center;
        }
        .debug-btn.active { background: #ff4400; color: #fff; border-color: #fff; } 
        #dbg-info { color: #0f0; border-top: 1px solid #0f0; padding-top: 6px; font-size: 11px; line-height: 1.4; }
    </style>
    <script src="js/game_data.js"></script>
</head>
<body>

    <svg style="position:fixed; top:-100%; left:-100%; width:0; height:0;">
        <filter id="water-filter">
            <feTurbulence type="fractalNoise" baseFrequency="0.015 0.015" numOctaves="3" seed="1" result="noise">
                <animate attributeName="baseFrequency" dur="15s" values="0.015 0.015;0.02 0.03;0.015 0.015" repeatCount="indefinite" />
            </feTurbulence>
            <feDisplacementMap in="SourceGraphic" in2="noise" scale="20" />
        </filter>
    </svg>

    <div id="debug-toggle" onclick="document.getElementById('debug-panel').style.display = document.getElementById('debug-panel').style.display==='block'?'none':'block'"></div>
    <div id="debug-panel">
        <button class="debug-btn" onclick="debugMaxStats()">★ All Max</button>
        <button class="debug-btn" onclick="debugResetStats()">↺ Reset Stats</button>
        <button class="debug-btn" onclick="debugNextTurn()">⏩ Skip Turn</button>
        <button id="force-heroine-btn" class="debug-btn" onclick="toggleForceHeroine()">♥ Force Heroine: OFF</button>
        <div id="dbg-info"></div>
    </div>

    <div id="game-container">
        <div id="background-layer"></div>
        <div id="map-spots-container"></div>

        <div id="top-ui-container">
            <div id="turn-display">
                <span style="margin-right:15px; font-weight:bold;"><i class="fa-solid fa-hourglass-start"></i> TURN</span>
                <span id="turn-count">1</span>/20
            </div>
            <button id="status-toggle-btn" class="ui-btn" onclick="toggleStats()">STATUS</button>
            <button id="log-btn" class="ui-btn" onclick="toggleLog()">LOG</button>
        </div>
        <div id="stats-panel"><div id="stat-list"></div></div>
        
        <div id="log-overlay">
            <div id="log-window"><div id="log-content"></div></div>
            <button id="log-close-btn" class="ui-btn" onclick="toggleLog()">CLOSE</button>
        </div>

        <div id="click-overlay" onclick="advanceMessage()"></div>
        <div id="message-window" onclick="advanceMessage()">
            <div id="location-badge"><span id="loc-icon"></span><span id="loc-name"></span><span id="loc-stats" style="margin-left:10px; font-size:13px; border-left:1px solid rgba(0,0,0,0.3); padding-left:10px;"></span></div>
            <div id="char-name-badge"></div>
            <div id="message-text"></div>
            <div id="result-display" style="min-height:25px; text-align:center; margin-top:5px; font-size:0.9em;"></div>
            <div id="page-cursor"><i class="fa-solid fa-caret-down"></i></div>
        </div>

        <div id="title-screen" class="overlay-screen">
            <div id="title-img-bg"></div>
            <h1>Days in Maghribal</h1><h2>- マグリバルにて -</h2><button id="start-btn" onclick="startOP()">GAME START</button>
        </div>
        <div id="op-screen" class="overlay-screen hidden-screen" onclick="nextOP()">
            <div id="op-text"></div><div style="position:absolute; bottom:30px;"><i class="fa-solid fa-caret-down" style="font-size:24px; color:#b08d55; animation:cursorBlink 1s infinite alternate;"></i></div>
        </div>
        <div id="ed-screen" class="overlay-screen hidden-screen">
            <div id="ed-rank"></div><div id="ed-heroine" style="color:#ffcc00; font-weight:bold; margin-bottom:20px;"></div><div id="ed-msg"></div><div id="ed-stats"></div>
            <div style="display:flex; gap:20px; align-items:center;">
                <button id="ed-log-btn" onclick="toggleLog()">REVIEW LOG</button>
                <button id="retry-btn" onclick="location.reload()">RETRY</button>
            </div>
        </div>
    </div>

    <script>
        /* --- システム初期化 --- */
        const sePi = new Audio('se/pi.mp3'); sePi.volume = 0.4;
        const seOp = new Audio('se/op.mp3'); seOp.volume = 0.5;

        const statColors = {
            health: '#ff4d4d', body: '#ffa500', mind: '#4da6ff', 
            magic: '#b366ff', fame: '#ffff4d', money: '#33cc33'
        };

        let stats = { health: 0, body: 0, mind: 0, magic: 0, fame: 0, money: 0 };
        let turn = 1, maxTurn = 20, isEventActive = false, isGameStarted = false;
        let messageQueue = [], currentMsgIndex = 0, pendingResultHtml = "", typeInterval, isTyping = false, targetText = "";
        let consecutiveNormalEvents = 0, lastEventWasHeroine = false, isForcedHeroine = false, isResultDisplayed = false;

        /* --- 座標データ --- */
        const spotAssignments = [
            {l:56, t:42, main:'fame',  sub:'money'},
            {l:87, t:19, main:'magic', sub:'mind'},
            {l:79, t:88, main:'health',sub:'body'},
            {l:88, t:70, main:'mind',  sub:'magic'},
            {l:8, t:64, main:'money', sub:'fame'},
            {l:10, t:10, main:'body',  sub:'health'},
            {l:72, t:55, main:'mind',  sub:'health'},
            {l:61.5, t:10.5, main:'magic', sub:'body'},
            {l:62, t:85, main:'money', sub:'mind'},
            {l:38, t:23, main:'fame',  sub:'magic'},
            {l:34, t:80, main:'body',  sub:'fame'},
            {l:22, t:20, main:'health',sub:'money'}
        ];

        window.onload = () => {
            if (typeof statKeys === 'undefined') { console.error("game_data.jsが読み込まれていません"); return; }
            
            const statContainer = document.getElementById("stat-list");
            statKeys.forEach(k => {
                statContainer.innerHTML += `
                    <div style="margin-bottom:10px;">
                        <div style="display:flex; justify-content:space-between; font-size:14px;">
                            <span class="stat-label" style="color:${statColors[k]};">
                                <i class="fa-solid ${statConfig[k].icon}"></i> ${statConfig[k].name}
                            </span>
                            <span id="stat-${k}" style="color:${statColors[k]}; font-weight:bold; text-shadow:1px 1px 1px #000;">Low</span>
                        </div>
                        <div class="stat-bar-bg"><div class="stat-bar-fill" id="bar-${k}" style="background:${statColors[k]}; box-shadow:0 0 5px ${statColors[k]};"></div></div>
                    </div>`;
            });

            const spotsContainer = document.getElementById("map-spots-container");
            spotAssignments.forEach((assign, i) => {
                if (!scenarios[i]) return;
                const spot = document.createElement("div");
                spot.className = "map-spot";
                spot.style.left = assign.l + "%"; spot.style.top = assign.t + "%";
                spot.onclick = (e) => { e.stopPropagation(); handleSpotClick(spot, i); };
                spot.innerHTML = `
                    <div class="spot-core"></div>
                    <div class="orb orb-main" style="background:${statColors[assign.main]};"></div>
                    <div class="orb orb-sub" style="background:${statColors[assign.sub]};"></div>
                    <div class="hint-container"><div class="hint-text"><i class="fa-solid ${scenarios[i].icon}"></i> ${scenarios[i].name}</div></div>
                `;
                spotsContainer.appendChild(spot);
            });
        };

        function startOP() {
            seOp.play();
            document.getElementById("title-screen").classList.add("hidden-screen");
            setTimeout(() => {
                document.getElementById("op-screen").classList.remove("hidden-screen");
                const opLines = ["陽が沈む西の地、マグリバル。", "ここには名声、富、知識、そして力が眠っている。", "残された時間は、そう長くはない。", "どの道を歩み、何者となるか。", "全ては汝の選択に委ねられている。", "自らの道を選択せよ。"];
                let idx = 0;
                const opDiv = document.getElementById("op-text");
                const showLine = () => { opDiv.style.opacity = 0; setTimeout(() => { opDiv.innerHTML = opLines[idx]; opDiv.style.opacity = 1; }, 400); };
                showLine();
                window.nextOP = () => {
                    idx++;
                    if (idx < opLines.length) { showLine(); } else {
                        addToLog("<i class='fa-solid fa-book-open'></i> 序章", opLines.join("\n"));
                        document.getElementById("op-screen").classList.add("hidden-screen");
                        document.getElementById("top-ui-container").style.display = "flex";
                        document.getElementById("background-layer").classList.add("visible");
                        setTimeout(() => { document.querySelectorAll('.map-spot').forEach(s => s.classList.add('spot-visible')); isGameStarted = true; }, 1000);
                    }
                };
            }, 500);
        }

        function handleSpotClick(el, idx) {
            if (!isGameStarted || isEventActive || turn > maxTurn) return;
            isEventActive = true; isResultDisplayed = false;
            
            // 選択されたヒントテキストを強調
            el.querySelector('.hint-text').classList.add('selected-yellow');

            // ★【修正ポイント】背景が動く前に、即座に全スポットを非表示にする
            document.querySelectorAll('.map-spot').forEach(s => s.classList.remove('spot-visible'));

            setTimeout(() => {
                const s = scenarios[idx], h = heroines[idx];
                const ratio = turn / maxTurn;
                const tier = ratio <= 1/6 ? 'newcomer' : (ratio <= 5/6 ? 'mid' : 'veteran');
                const mainK = spotAssignments[idx].main;

                let isHeroine = false, displayMsg = "", actualChanges = {}, outcome = 'success';
                let chance = isForcedHeroine ? 1.0 : (stats[mainK] / 50) + (consecutiveNormalEvents * 0.1);
                if (chance < 0.05) chance = 0.05; if (lastEventWasHeroine && !isForcedHeroine) chance = 0;

                if (Math.random() < chance) {
                    isHeroine = true; lastEventWasHeroine = true; consecutiveNormalEvents = 0;
                    displayMsg = h.events[Math.min(h.progress, 4)]; if (h.progress < 4) h.progress++;
                    h.affection++; actualChanges[mainK] = 5;
                } else {
                    isHeroine = false; lastEventWasHeroine = false; consecutiveNormalEvents++;
                    const rand = Math.random();
                    if (tier === 'newcomer') outcome = rand < 1/3 ? 'failure' : 'success';
                    else if (tier === 'mid') outcome = rand < 0.2 ? 'failure' : (rand < 0.8 ? 'success' : 'great');
                    else outcome = rand < 0.6 ? 'success' : 'great';
                    const list = s.events[tier][outcome]; displayMsg = list[Math.floor(Math.random() * list.length)];
                    let mult = outcome === 'failure' ? 0.2 : (outcome === 'great' ? 2.0 : 1.0);
                    for (let k in s.baseChanges) actualChanges[k] = s.baseChanges[k] > 0 ? Math.floor(s.baseChanges[k] * mult) : s.baseChanges[k];
                }

                for (let k in actualChanges) { stats[k] = Math.max(0, Math.min(stats[k] + actualChanges[k], 50)); updateUI(k); }
                checkRankUpdate();

                let changeLog = "";
                for (let k in actualChanges) if (actualChanges[k] !== 0) changeLog += ` <span style="color:${statColors[k]}; font-size:0.8em;">${statConfig[k].name}${actualChanges[k] > 0 ? '⇑' : '⇓'}</span>`;
                const heroLabel = isHeroine ? `(<i class="fa-solid ${h.icon}"></i> ${h.title} ${h.name})` : "";
                const logLabel = isHeroine ? heroLabel : (outcome === 'great' ? " <span style='color:#ffcc00;'>[大成功!]</span>" : (outcome === 'failure' ? " <span style='color:#888;'>[失敗]</span>" : ""));
                addToLog(`Turn ${turn} : <i class="fa-solid ${s.icon}"></i> ${s.name} ${logLabel}${changeLog}`, displayMsg);

                // 背景の移動・拡大
                const bg = document.getElementById("background-layer");
                bg.classList.add("blur-bg");
                bg.style.transformOrigin = `${spotAssignments[idx].l}% ${spotAssignments[idx].t}%`;
                bg.style.transform = `scale(${s.zoom || 2.5})`;

                messageQueue = displayMsg.split('\n'); currentMsgIndex = 0;
                pendingResultHtml = getResultHtml(actualChanges, outcome === 'failure');

                document.getElementById("loc-icon").innerHTML = `<i class="fa-solid ${s.icon}"></i>`;
                document.getElementById("loc-name").innerText = s.name;
                document.getElementById("loc-stats").innerHTML = `<i class="fa-solid fa-gavel"></i> ${"★".repeat(s.security)} / <i class="fa-solid fa-scale-unbalanced"></i> ${"★".repeat(s.economy)}`;
                const cb = document.getElementById("char-name-badge");
                if (isHeroine) { cb.innerHTML = `<i class="fa-solid ${h.icon}"></i> ${h.title} ${h.name}`; cb.style.display = "flex"; } else cb.style.display = "none";

                document.getElementById("message-text").innerHTML = ""; document.getElementById("result-display").innerHTML = "";
                document.getElementById("message-window").classList.add("active"); document.getElementById("click-overlay").classList.add("active");
                setTimeout(advanceMessage, 400); 
            }, 100); // 100msで地点を消してから背景を動かす
        }

        function advanceMessage() {
            if (!isEventActive) return; if (isTyping) { finishTyping(); return; }
            if (currentMsgIndex < messageQueue.length) { targetText = messageQueue[currentMsgIndex++]; typeWriter(document.getElementById("message-text"), targetText, 10); }
            else if (isResultDisplayed) { closeEvent(); }
        }

        function typeWriter(el, text, speed) {
            let i = 0; el.innerHTML = ""; isTyping = true; document.getElementById("page-cursor").style.display = "none";
            typeInterval = setInterval(() => { if (i < text.length) el.innerHTML += text.charAt(i++); else finishTyping(); }, speed);
        }

        function finishTyping() {
            clearInterval(typeInterval); isTyping = false; document.getElementById("message-text").innerHTML = targetText;
            if (currentMsgIndex === messageQueue.length) { setTimeout(() => { document.getElementById("result-display").innerHTML = pendingResultHtml; isResultDisplayed = true; }, 500); }
            document.getElementById("page-cursor").style.display = "block";
        }

        function closeEvent() {
            const bg = document.getElementById("background-layer"); bg.style.transform = "scale(1)"; bg.classList.remove("blur-bg");
            document.getElementById("message-window").classList.remove("active"); document.getElementById("click-overlay").classList.remove("active");
            setTimeout(() => {
                if (turn >= maxTurn) showEnding();
                else { turn++; document.getElementById("turn-count").innerText = turn; document.querySelectorAll('.map-spot').forEach(s => { s.classList.add('spot-visible'); s.querySelector('.hint-text').className = 'hint-text'; }); isEventActive = false; }
            }, 500);
        }

        function showEnding() {
            document.getElementById("ed-screen").classList.remove("hidden-screen");
            const total = Object.values(stats).reduce((sum, v) => sum + v, 0);
            let rank = total >= 150 ? "LEGEND" : (total >= 100 ? "GOLD" : (total >= 50 ? "SILVER" : "BRONZE"));
            document.getElementById("ed-rank").innerText = `Rank: ${rank}`;
            let best = heroines.reduce((a, b) => a.affection > b.affection ? a : b);
            document.getElementById("ed-heroine").innerText = (best && best.affection > 0) ? `Partner: ${best.title} ${best.name}` : "孤独な旅路";
            let h = ""; statKeys.forEach(k => { h += `<div class="ed-stat-box"><i class="fa-solid ${statConfig[k].icon}"></i> ${statConfig[k].name}<span class="ed-stat-val">${Math.floor(stats[k])}</span></div>`; });
            document.getElementById("ed-stats").innerHTML = h;
        }

        function updateUI(k) {
            const v = stats[k], labels = ["Low", "Normal", "High", "Expert", "Master", "Legend"];
            document.getElementById(`stat-${k}`).innerText = labels[Math.min(Math.floor(v / 10), 5)];
            document.getElementById(`bar-${k}`).style.width = (v * 2) + "%";
        }
        function toggleStats() { sePi.currentTime = 0; sePi.play(); const p = document.getElementById("stats-panel"); p.style.display = p.style.display === "block" ? "none" : "block"; }
        function toggleLog() {
            sePi.currentTime = 0; sePi.play(); const l = document.getElementById("log-overlay");
            if (l.style.display === "flex") { l.style.display = "none"; } else { l.style.display = "flex"; document.getElementById("log-window").scrollTop = document.getElementById("log-window").scrollHeight; }
        }
        function checkRankUpdate() {
            const total = Object.values(stats).reduce((sum, v) => sum + v, 0);
            const btn = document.getElementById("status-toggle-btn");
            let rank = total >= 150 ? "legend" : (total >= 100 ? "gold" : (total >= 50 ? "silver" : "bronze"));
            [btn, document.getElementById("stats-panel")].forEach(el => { el.classList.remove("rank-silver", "rank-gold", "rank-legend"); if (rank !== "bronze") el.classList.add("rank-" + rank); });
        }
        function getResultHtml(changes, isFail) {
            let h = '<span class="result-diff">';
            for (let k in changes) if (changes[k] !== 0) h += `<span style="color:${statColors[k]}; margin:0 5px; text-shadow:1px 1px 1px #000;"><i class="fa-solid ${statConfig[k].icon}"></i> ${statConfig[k].name}${changes[k] > 0 ? '⇑' : '⇓'}</span>`;
            if (isFail) h += '<div style="color:#ff5555; font-size:0.8em;">※失敗により効果減少</div>';
            return h + '</span>';
        }
        function addToLog(h, t) { const entry = `<div class="log-entry">${h ? `<div class="log-header">${h}</div>` : ""}<div>${t ? t.replace(/\n/g, '<br>') : ""}</div></div>`; document.getElementById("log-content").innerHTML += entry; }

        function debugMaxStats() { statKeys.forEach(k => { stats[k] = 50; updateUI(k); }); checkRankUpdate(); }
        function debugResetStats() { statKeys.forEach(k => { stats[k] = 0; updateUI(k); }); checkRankUpdate(); }
        function debugNextTurn() { if (turn < maxTurn) { turn++; document.getElementById("turn-count").innerText = turn; } else showEnding(); }
        function toggleForceHeroine() { isForcedHeroine = !isForcedHeroine; document.getElementById("force-heroine-btn").innerText = isForcedHeroine ? "♥ Force Heroine: ON" : "♥ Force Heroine: OFF"; document.getElementById("force-heroine-btn").classList.toggle("active", isForcedHeroine); }
        
        setInterval(() => {
            if(!isGameStarted) return;
            const tier = (turn / maxTurn <= 1 / 6) ? "NEWCOMER" : (turn / maxTurn <= 5 / 6 ? "MID" : "VETERAN");
            document.getElementById('dbg-info').innerHTML = `Turn: ${turn}/${maxTurn}<br>Tier: ${tier}<br>Streak: ${consecutiveNormalEvents}<br>Forced: ${isForcedHeroine ? 'ON' : 'OFF'}`;
        }, 500);
    </script>
</body>
</html>
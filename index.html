<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Days in Maghribal - Polish Ver</title>
    <link rel="icon" href="data:,">
    
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="css/style.css">

    <script src="js/game_data.js"></script>
</head>
<body>

    <svg style="position:fixed; top:-100%; left:-100%; width:0; height:0;">
        <filter id="water-filter">
            <feTurbulence type="fractalNoise" baseFrequency="0.015 0.015" numOctaves="3" seed="1" result="noise">
                <animate attributeName="baseFrequency" dur="15s" values="0.015 0.015;0.02 0.03;0.015 0.015" repeatCount="indefinite" />
            </feTurbulence>
            <feDisplacementMap in="SourceGraphic" in2="noise" scale="20" />
        </filter>
    </svg>

    <div id="debug-toggle-btn" onclick="toggleDebugPanel()"><i class="fa-solid fa-gear"></i></div>
    
    <div id="debug-panel">
        <button class="debug-btn" onclick="debugMaxStats()">★ All Max</button>
        <button class="debug-btn" onclick="debugResetStats()">↺ Reset Stats</button>
        <button class="debug-btn" onclick="debugNextTurn()">⏩ Skip Turn</button>
        <button id="force-heroine-btn" class="debug-btn" onclick="toggleForceHeroine()">♥ Force Heroine: OFF</button>
        <div id="dbg-info"></div>
    </div>

    <div id="game-container">
        <div id="background-layer"></div>
        <div id="map-spots-container"></div>

        <div id="top-ui-container">
            <div id="turn-display">
                <span style="margin-right:15px; font-weight:bold;"><i class="fa-solid fa-hourglass-start"></i> TURN</span>
                <span id="turn-count">1</span>/20
            </div>
            <button id="status-toggle-btn" class="ui-btn" onclick="toggleStats()">STATUS</button>
            <button id="log-btn" class="ui-btn" onclick="toggleLog()">LOG</button>
        </div>
        <div id="stats-panel"><div id="stat-list"></div></div>
        
        <div id="log-overlay">
            <div id="log-window"><div id="log-content"></div></div>
            <button id="log-close-btn" class="ui-btn" onclick="toggleLog()">CLOSE</button>
        </div>

        <div id="click-overlay" onclick="advanceMessage()"></div>
        <div id="message-window" onclick="advanceMessage()">
            <div id="location-badge"><span id="loc-icon"></span><span id="loc-name"></span><span id="loc-stats" style="margin-left:10px; font-size:13px; border-left:1px solid rgba(0,0,0,0.3); padding-left:10px;"></span></div>
            <div id="char-name-badge"></div>
            <div id="message-text"></div>
            <div id="result-display" style="min-height:25px; text-align:center; margin-top:5px; font-size:0.9em;"></div>
            <div id="page-cursor"><i class="fa-solid fa-caret-down"></i></div>
        </div>

        <div id="title-screen" class="overlay-screen">
            <div id="title-img-bg"></div>
            
            <div class="title-logo-container">
                <h1 class="size-days">DAYS</h1>
                <h1 class="size-in">IN</h1>
                <h1 class="size-magh">MAGHRIBAL</h1>
            </div>
            <div class="title-underline"></div>
            <h2>- マグリバルにて -</h2>
            
            <button id="start-btn" onclick="startOP()">GAME START</button>
        </div>

        <div id="op-screen" class="overlay-screen hidden-screen" onclick="nextOP()">
            <div id="op-text"></div><div style="position:absolute; bottom:30px;"><i class="fa-solid fa-caret-down" style="font-size:24px; color:#b08d55; animation:cursorBlink 1s infinite alternate;"></i></div>
        </div>
        <div id="ed-screen" class="overlay-screen hidden-screen">
            <div id="ed-rank"></div><div id="ed-heroine" style="color:#ffcc00; font-weight:bold; margin-bottom:20px;"></div><div id="ed-msg"></div><div id="ed-stats"></div>
            <div style="display:flex; gap:20px; align-items:center;">
                <button id="ed-log-btn" onclick="toggleLog()">REVIEW LOG</button>
                <button id="retry-btn" onclick="location.reload()">RETRY</button>
            </div>
        </div>
    </div>

    <script>
        /* --- システム初期化 --- */
        const sePi = new Audio('se/pi.mp3'); sePi.volume = 0.4;
        const seOp = new Audio('se/op.mp3'); seOp.volume = 0.5;
        
        // ★ 効果音の追加
        const seFootstep = new Audio('se/za.mp3'); seFootstep.volume = 0.5;
        const sePage = new Audio('se/pera.mp3'); sePage.volume = 0.5;

        // BGM設定
        const bgmOp = new Audio('bgm/op.mp3');
        bgmOp.loop = true; bgmOp.volume = 0.3;

        const statColors = { health: '#ff4d4d', body: '#ffa500', mind: '#4da6ff', magic: '#b366ff', fame: '#ffff4d', money: '#33cc33' };
        let stats = { health: 0, body: 0, mind: 0, magic: 0, fame: 0, money: 0 };
        let turn = 1, maxTurn = 20, isEventActive = false, isGameStarted = false;
        let messageQueue = [], currentMsgIndex = 0, pendingResultHtml = "", typeInterval, isTyping = false, targetText = "";
        let consecutiveNormalEvents = 0, lastEventWasHeroine = false, isForcedHeroine = false, isResultDisplayed = false;
        let masterEvents = [];

        window.onload = async () => {
            if (typeof statKeys === 'undefined' || typeof scenarios === 'undefined' || typeof spotAssignments === 'undefined') {
                console.error("Critical: game_data.js is not loaded correctly.");
                return;
            }
            
            try {
                // 通常イベントの読み込み
                const resNormal = await fetch('data/events.json');
                masterEvents = await resNormal.json();

                // ヒロインイベントの読み込み
                const resHeroine = await fetch('data/heroine_events.json');
                const heroineData = await resHeroine.json();
                
                // 読み込んだデータを反映
                heroineData.forEach(hd => {
                    const target = heroines.find(h => h.name === hd.name);
                    if (target) target.events = hd.events;
                });

                console.log("JSON Load Success");
            } catch(e) {
                console.warn("JSON Load Failed.");
            }

            // UI生成
            const statContainer = document.getElementById("stat-list");
            statKeys.forEach(k => {
                statContainer.innerHTML += `
                    <div style="margin-bottom:10px;">
                        <div style="display:flex; justify-content:space-between; font-size:14px;">
                            <span class="stat-label" style="color:${statColors[k]};">
                                <i class="fa-solid ${statConfig[k].icon}"></i> ${statConfig[k].name}
                            </span>
                            <span id="stat-${k}" style="color:${statColors[k]}; font-weight:bold; text-shadow:1px 1px 1px #000;">Low</span>
                        </div>
                        <div class="stat-bar-bg"><div class="stat-bar-fill" id="bar-${k}" style="background:${statColors[k]}; box-shadow:0 0 5px ${statColors[k]};"></div></div>
                    </div>`;
            });

            const spotsContainer = document.getElementById("map-spots-container");
            spotAssignments.forEach((assign, i) => {
                if (!scenarios[i]) return;
                const spot = document.createElement("div");
                spot.className = "map-spot";
                spot.style.left = assign.l + "%"; spot.style.top = assign.t + "%";
                spot.onclick = (e) => { e.stopPropagation(); handleSpotClick(spot, i); };
                spot.innerHTML = `
                    <div class="spot-core"></div>
                    <div class="orb orb-main" style="background:${statColors[assign.main]};"></div>
                    <div class="orb orb-sub" style="background:${statColors[assign.sub]};"></div>
                    <div class="hint-container"><div class="hint-text"><i class="fa-solid ${scenarios[i].icon}"></i> ${scenarios[i].name}</div></div>
                `;
                spotsContainer.appendChild(spot);
            });
        };

        function startOP() {
            bgmOp.play().catch(e => console.warn("Audio play blocked."));
            seOp.play();
            document.getElementById("title-screen").classList.add("hidden-screen");
            setTimeout(() => {
                document.getElementById("op-screen").classList.remove("hidden-screen");
                const opLines = ["陽が沈む西の地、マグリバル。", "ここには名声、富、知識、そして力が眠っている。", "残された時間は、そう長くはない。", "どの道を歩み、何者となるか。", "全ては汝の選択に委ねられている。", "自らの道を選択せよ。"];
                let idx = 0;
                const opDiv = document.getElementById("op-text");
                const showLine = () => { opDiv.style.opacity = 0; setTimeout(() => { opDiv.innerHTML = opLines[idx]; opDiv.style.opacity = 1; }, 400); };
                showLine();
                window.nextOP = () => {
                    idx++;
                    if (idx < opLines.length) { showLine(); } else {
                        bgmOp.pause();
                        bgmOp.currentTime = 0;
                        addToLog("<i class='fa-solid fa-book-open'></i> 序章", opLines.join("\n"));
                        document.getElementById("op-screen").classList.add("hidden-screen");
                        document.getElementById("top-ui-container").style.display = "flex";
                        document.getElementById("background-layer").classList.add("visible");
                        setTimeout(() => { document.querySelectorAll('.map-spot').forEach(s => s.classList.add('spot-visible')); isGameStarted = true; }, 1000);
                    }
                };
            }, 500);
        }

        function handleSpotClick(el, idx) {
            if (!isGameStarted || isEventActive || turn > maxTurn) return;
            isEventActive = true; isResultDisplayed = false;
            
            // ★ 足音の再生
            seFootstep.currentTime = 0;
            seFootstep.play();

            el.querySelector('.hint-text').classList.add('selected-yellow');
            document.querySelectorAll('.map-spot').forEach(s => s.classList.remove('spot-visible'));

            setTimeout(() => {
                const s = scenarios[idx], h = heroines[idx];
                const ratio = turn / maxTurn;
                const tier = ratio <= 1/6 ? 'newcomer' : (ratio <= 5/6 ? 'mid' : 'veteran');
                const mainK = spotAssignments[idx].main;

                let isHeroine = false, displayMsg = "", actualChanges = {}, outcome = 'success';
                let chance = isForcedHeroine ? 1.0 : (stats[mainK] / 50) + (consecutiveNormalEvents * 0.1);
                if (chance < 0.05) chance = 0.05; if (lastEventWasHeroine && !isForcedHeroine) chance = 0;

                if (Math.random() < chance) {
                    isHeroine = true; lastEventWasHeroine = true; consecutiveNormalEvents = 0;
                    displayMsg = h.events[Math.min(h.progress, 4)]; if (h.progress < 4) h.progress++;
                    h.affection++; actualChanges[mainK] = 5;
                } else {
                    isHeroine = false; lastEventWasHeroine = false; consecutiveNormalEvents++;
                    const rand = Math.random();
                    if (tier === 'newcomer') outcome = rand < 1/3 ? 'failure' : 'success';
                    else if (tier === 'mid') outcome = rand < 0.2 ? 'failure' : (rand < 0.8 ? 'success' : 'great');
                    else outcome = rand < 0.6 ? 'success' : 'great';
                    
                    const pool = masterEvents.filter(e => e.area === s.name && e.tier === tier && e.outcome === outcome);
                    if (pool.length > 0) {
                        const ev = pool[Math.floor(Math.random() * pool.length)];
                        displayMsg = ev.text;
                        actualChanges = ev.changes || {};
                    } else {
                        displayMsg = "静かな時が流れた。";
                    }
                }

                for (let k in actualChanges) { stats[k] = Math.max(0, Math.min(stats[k] + actualChanges[k], 50)); updateUI(k); }
                checkRankUpdate();

                let changeLog = "";
                for (let k in actualChanges) if (actualChanges[k] !== 0) changeLog += ` <span style="color:${statColors[k]}; font-size:0.8em;">${statConfig[k].name}${actualChanges[k] > 0 ? '⇑' : '⇓'}</span>`;
                const logLabel = isHeroine ? `(<i class="fa-solid ${h.icon}"></i> ${h.title} ${h.name})` : (outcome === 'great' ? " <span style='color:#ffcc00;'>[大成功!]</span>" : (outcome === 'failure' ? " <span style='color:#888;'>[失敗]</span>" : ""));
                addToLog(`Turn ${turn} : <i class="fa-solid ${s.icon}"></i> ${s.name} ${logLabel}${changeLog}`, displayMsg);

                const bg = document.getElementById("background-layer");
                bg.classList.add("blur-bg");
                bg.style.transformOrigin = `${spotAssignments[idx].l}% ${spotAssignments[idx].t}%`;
                bg.style.transform = `scale(${s.zoom || 2.5})`;

                messageQueue = displayMsg.split('\n'); currentMsgIndex = 0;
                pendingResultHtml = getResultHtml(actualChanges, outcome === 'failure');

                document.getElementById("loc-icon").innerHTML = `<i class="fa-solid ${s.icon}"></i>`;
                document.getElementById("loc-name").innerText = s.name;
                const getStars = (count) => "★".repeat(count) + "☆".repeat(5 - count);
                document.getElementById("loc-stats").innerHTML = `<i class="fa-solid fa-gavel"></i> ${getStars(s.security)} / <i class="fa-solid fa-scale-unbalanced"></i> ${getStars(s.economy)}`;

                const cb = document.getElementById("char-name-badge");
                if (isHeroine) { cb.innerHTML = `<i class="fa-solid ${h.icon}"></i> ${h.title} ${h.name}`; cb.style.display = "flex"; } else cb.style.display = "none";

                document.getElementById("message-text").innerHTML = ""; document.getElementById("result-display").innerHTML = "";
                document.getElementById("message-window").classList.add("active"); document.getElementById("click-overlay").classList.add("active");
                setTimeout(advanceMessage, 400); 
            }, 100);
        }

        function advanceMessage() {
            if (!isEventActive) return; if (isTyping) { finishTyping(); return; }
            if (currentMsgIndex < messageQueue.length) { targetText = messageQueue[currentMsgIndex++]; typeWriter(document.getElementById("message-text"), targetText, 10); }
            else if (isResultDisplayed) { closeEvent(); }
        }

        function typeWriter(el, text, speed) {
            let i = 0; el.innerHTML = ""; isTyping = true; document.getElementById("page-cursor").style.display = "none";
            typeInterval = setInterval(() => { if (i < text.length) el.innerHTML += text.charAt(i++); else finishTyping(); }, speed);
        }

        function finishTyping() {
            clearInterval(typeInterval); isTyping = false; document.getElementById("message-text").innerHTML = targetText;
            if (currentMsgIndex === messageQueue.length) { 
                setTimeout(() => { 
                    // ★ ページめくり音の再生（リザルト表示タイミング）
                    sePage.currentTime = 0;
                    sePage.play();
                    document.getElementById("result-display").innerHTML = pendingResultHtml; 
                    isResultDisplayed = true; 
                }, 500); 
            }
            document.getElementById("page-cursor").style.display = "block";
        }

        function closeEvent() {
            const bg = document.getElementById("background-layer"); bg.style.transform = "scale(1)"; bg.classList.remove("blur-bg");
            document.getElementById("message-window").classList.remove("active"); document.getElementById("click-overlay").classList.remove("active");
            setTimeout(() => {
                if (turn >= maxTurn) showEnding();
                else { turn++; document.getElementById("turn-count").innerText = turn; document.querySelectorAll('.map-spot').forEach(s => { s.classList.add('spot-visible'); s.querySelector('.hint-text').className = 'hint-text'; }); isEventActive = false; }
            }, 500);
        }

        function showEnding() {
            document.getElementById("ed-screen").classList.remove("hidden-screen");
            const total = Object.values(stats).reduce((sum, v) => sum + v, 0);
            let rank = total >= 150 ? "LEGEND" : (total >= 100 ? "GOLD" : (total >= 50 ? "SILVER" : "BRONZE"));
            document.getElementById("ed-rank").innerText = `Rank: ${rank}`;
            let best = heroines.reduce((a, b) => a.affection > b.affection ? a : b);
            document.getElementById("ed-heroine").innerText = (best && best.affection > 0) ? `Partner: ${best.title} ${best.name}` : "孤独な旅路";
            let h = ""; statKeys.forEach(k => { h += `<div class="ed-stat-box"><i class="fa-solid ${statConfig[k].icon}"></i> ${statConfig[k].name}<span class="ed-stat-val">${Math.floor(stats[k])}</span></div>`; });
            document.getElementById("ed-stats").innerHTML = h;
        }

        function updateUI(k) {
            const v = stats[k], labels = ["Low", "Normal", "High", "Expert", "Master", "Legend"];
            document.getElementById(`stat-${k}`).innerText = labels[Math.min(Math.floor(v / 10), 5)];
            document.getElementById(`bar-${k}`).style.width = (v * 2) + "%";
        }
        function toggleStats() { sePi.currentTime = 0; sePi.play(); const p = document.getElementById("stats-panel"); p.style.display = p.style.display === "block" ? "none" : "block"; }
        function toggleLog() {
            sePi.currentTime = 0; sePi.play(); const l = document.getElementById("log-overlay");
            if (l.style.display === "flex") { l.style.display = "none"; } else { l.style.display = "flex"; document.getElementById("log-window").scrollTop = document.getElementById("log-window").scrollHeight; }
        }
        function checkRankUpdate() {
            const total = Object.values(stats).reduce((sum, v) => sum + v, 0);
            const btn = document.getElementById("status-toggle-btn");
            let rank = total >= 150 ? "legend" : (total >= 100 ? "gold" : (total >= 50 ? "silver" : "bronze"));
            [btn, document.getElementById("stats-panel")].forEach(el => { el.classList.remove("rank-silver", "rank-gold", "rank-legend"); if (rank !== "bronze") el.classList.add("rank-" + rank); });
        }
        function getResultHtml(changes, isFail) {
            let h = '<span class="result-diff">';
            for (let k in changes) if (changes[k] !== 0) h += `<span style="color:${statColors[k]}; margin:0 5px; text-shadow:1px 1px 1px #000;"><i class="fa-solid ${statConfig[k].icon}"></i> ${statConfig[k].name}${changes[k] > 0 ? '⇑' : '⇓'}</span>`;
            if (isFail) h += '<div style="color:#ff5555; font-size:0.8em;">※失敗により効果減少</div>';
            return h + '</span>';
        }
        function addToLog(h, t) { const entry = `<div class="log-entry">${h ? `<div class="log-header">${h}</div>` : ""}<div>${t ? t.replace(/\n/g, '<br>') : ""}</div></div>`; document.getElementById("log-content").innerHTML += entry; }

        /* --- デバッグ機能 --- */
        function toggleDebugPanel() {
            const panel = document.getElementById("debug-panel");
            panel.style.display = panel.style.display === "block" ? "none" : "block";
        }
        function debugMaxStats() { statKeys.forEach(k => { stats[k] = 50; updateUI(k); }); checkRankUpdate(); }
        function debugResetStats() { statKeys.forEach(k => { stats[k] = 0; updateUI(k); }); checkRankUpdate(); }
        function debugNextTurn() { if (turn < maxTurn) { turn++; document.getElementById("turn-count").innerText = turn; } else showEnding(); }
        function toggleForceHeroine() { isForcedHeroine = !isForcedHeroine; document.getElementById("force-heroine-btn").innerText = isForcedHeroine ? "♥ Force Heroine: ON" : "♥ Force Heroine: OFF"; document.getElementById("force-heroine-btn").classList.toggle("active", isForcedHeroine); }
        
        setInterval(() => {
            if(!isGameStarted) return;
            const tier = (turn / maxTurn <= 1 / 6) ? "NEWCOMER" : (turn / maxTurn <= 5 / 6 ? "MID" : "VETERAN");
            document.getElementById('dbg-info').innerHTML = `Turn: ${turn}/${maxTurn}<br>Tier: ${tier}<br>Streak: ${consecutiveNormalEvents}<br>Forced: ${isForcedHeroine ? 'ON' : 'OFF'}`;
        }, 500);
    </script>
</body>
</html>